{% extends 'adminpanel/base_admin_with_nav.html' %}
{% load static %}
{% load quote_filters %}
{% block page_title %}Booking List{% endblock %}
{% block breadcrumb %}Booking List{% endblock %}
{% block admin_content %}
<style>
  .text-primary {
      color: #F15A29 !important;
    }
  
  .outstanding-payments-table {
    font-size: 0.9rem;
  }
  
  .outstanding-payments-table .btn-group .btn {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
  }
  
  .outstanding-amount {
    font-weight: bold;
    font-size: 1.1rem;
  }
  
  .alert-warning {
    border-left: 4px solid #ffc107;
  }
</style>

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.3.0/css/dataTables.dataTables.css" />

<div class="row">
  <a href="{% url 'admin_dashboard' %}" class="text-primary mb-4"><i class="fa fa-arrow-left" aria-hidden="true"></i>
    Back to dashboard</a>
  <!-- Left Column: Bookings Table -->
  <div class="col-12 col-lg-2">
    <h4 class="mb-3"><i class="fa-solid fa-filter me-2 text-primary"></i> Filters</h4>
    <form method="get" class="d-grid gap-4">
  
      <!-- STATUS FILTER -->
      <div>
        <label class="form-label fw-semibold">Status</label>
        {% for s in status_list %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="status" value="{{ s }}" id="status-{{ s }}"
              {% if s in selected_statuses %}checked{% endif %}>
            <label class="form-check-label" for="status-{{ s }}">{{ s|capfirst }}</label>
          </div>
        {% endfor %}
      </div>
  
      <!-- SERVICE CATEGORY FILTER -->
      <div>
        <label class="form-label fw-semibold">Service</label>
        {% for cat in service_categories %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="category" value="{{ cat.id }}" id="cat-{{ cat.id }}"
            {% if cat.id|stringformat:"s" in selected_categories %}checked{% endif %}>
            <label class="form-check-label" for="cat-{{ cat.id }}">{{ cat.name }}</label>
          </div>
        {% endfor %}
        </div>

      <!-- DATE FILTER -->
      <div>
        <label class="form-label fw-semibold">Date</label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="date_filter" value="today"
            {% if selected_date_filter == "today" %}checked{% endif %}>
          <label class="form-check-label">Today</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="date_filter" value="last_7"
            {% if selected_date_filter == "last_7" %}checked{% endif %}>
          <label class="form-check-label">Last 7 Days</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="date_filter" value="last_30"
            {% if selected_date_filter == "last_30" %}checked{% endif %}>
          <label class="form-check-label">Last 30 Days</label>
        </div>
      </div>
  
      <button type="submit" class="btn btn-outline-primary w-100">Apply Filters</button>
      <a href="{% url 'booking_list' %}" class="btn btn-link p-0">❌ Clear All Filters</a>

    </form>
  </div>
  
  <!-- Right Column: Bookings Table -->
  <div class="col-12 col-lg-10">
    {% csrf_token %}

    {% if bookings %}
    <div class="table-responsive">
      {% if selected_statuses or selected_categories %}
  <div class="alert alert-light d-inline-block mb-3">
    <strong>Active Filters:</strong>

    {% if selected_statuses %}
      <span class="me-2">Status:</span>
      {% for s in selected_statuses %}
        <span class="badge bg-primary me-1">{{ s|capfirst }}</span>
      {% endfor %}
    {% endif %}

    {% if selected_categories %}
      <span class="ms-3 me-2">Service:</span>
      {% for cat in service_categories %}
        {% if cat.id|stringformat:"s" in selected_categories %}
          <span class="badge bg-info me-1">{{ cat.name }}</span>
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if selected_date_filter %}
  <span class="ms-3 me-2">Date:</span>
  <span class="badge bg-warning text-dark">
    {% if selected_date_filter == "today" %}Today
    {% elif selected_date_filter == "last_7" %}Last 7 Days
    {% elif selected_date_filter == "last_30" %}Last 30 Days
    {% endif %}
  </span>
{% endif %}

    <a href="{% url 'booking_list' %}" class="ms-3">❌ Clear</a>
  </div>
{% endif %}

<!-- Outstanding Payments Table -->
{% if outstanding_payments %}
<div class="alert alert-warning mb-4">
  <h5 class="mb-3"><i class="fa-solid fa-exclamation-triangle me-2"></i>Outstanding Payments</h5>
  <p class="mb-3">The following completed bookings require payment follow-up:</p>
  
  <div class="table-responsive">
    <table id="outstandingPaymentsTable" class="table table-sm table-hover align-middle outstanding-payments-table">
      <thead class="table-warning">
        <tr>
          <th>Booking ID</th>
          <th>Customer</th>
          <th>Service</th>
          <th>Date</th>
          <th>Total Amount</th>
          <th>Paid Amount</th>
          <th>Outstanding</th>
          <th>Payment Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for booking in outstanding_payments %}
        <tr>
          <td><strong>#{{ booking.id }}</strong></td>
          <td>{{ booking.name }}</td>
          <td>{{ booking.service_cat.name }}</td>
          <td>{{ booking.date|date:"M d, Y" }}</td>
          <td><strong>${{ booking.price|floatformat:2 }}</strong></td>
          <td class="text-success">${{ booking.get_paid_amount|floatformat:2 }}</td>
          <td class="text-danger outstanding-amount">${{ booking.price|sub:booking.get_paid_amount|floatformat:2 }}</td>
          <td>
            <span class="badge 
              {% if booking.payment_status == 'partial' %}bg-warning text-dark
              {% elif booking.payment_status == 'unpaid' %}bg-danger
              {% else %}bg-secondary
              {% endif %}">
              {{ booking.get_payment_status_display }}
            </span>
          </td>
          <td>
            <div class="btn-group" role="group">
              <a href="{% url 'booking_detail_admin' booking.id %}" class="btn btn-sm btn-outline-primary">
                <i class="fa-solid fa-eye"></i> View
              </a>
              {% if booking.payment_status == 'unpaid' %}
                <button type="button" class="btn btn-sm btn-success" onclick="sendPaymentLink({{ booking.id }}, 'full')">
                  <i class="fa-solid fa-credit-card"></i> Send Full Payment
                </button>
              {% elif booking.payment_status == 'partial' %}
                <button type="button" class="btn btn-sm btn-warning" onclick="sendPaymentLink({{ booking.id }}, 'final')">
                  <i class="fa-solid fa-credit-card"></i> Send Final Payment
                </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<h4 class="mb-0">
  <i class="fa-solid fa-calendar-plus me-2 text-primary"></i>All Bookings
</h4>
      <table id="bookingsTable" class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Service</th>
            <th>Date</th>
            <th>Duration</th>
            <th>Price</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for booking in bookings %}
          <tr>
            <td><strong>{{ booking.service_cat.name }}</strong></td>
            <td>{{ booking.date }}</td>
            <td>{{ booking.hours_requested }} hours</td>
            <td>${{ booking.price }}</td>
            <td>
              <span class="badge bg-secondary">{{ booking.status }}</span>
            </td>
            <td>
              {% if booking.service_cat.name == 'Handyman' %}
                <a href="{% url 'quote_detail' booking.id %}" class="btn btn-sm btn-outline-primary">View</a>
              {% else %}
                <a href="{% url 'booking_detail_admin' booking.id %}" class="btn btn-sm btn-outline-primary">View</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <p>You have no booking yet.</p>
    {% endif %}
    
  </div>
  <a href="{% url 'admin_dashboard' %}" class="text-primary"><i class="fa fa-arrow-left" aria-hidden="true"></i>
    Back to dashboard</a>
</div>



<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/2.3.0/js/dataTables.js"></script>

<script>
      // Initialize DataTables
      $('#bookingsTable').DataTable();
      $('#outstandingPaymentsTable').DataTable({
        "pageLength": 10,
        "order": [[0, "desc"]]
      });

      // Payment link functionality
      function sendPaymentLink(bookingId, paymentType) {
        const button = event.target;
        const originalText = button.innerHTML;
        
        // Show loading state
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Sending...';
        button.disabled = true;
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('/adminpanel/send-payment-link/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify({
            booking_id: bookingId,
            payment_type: paymentType
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success message
            showAlert('success', data.message);
            
            // Reload page to update payment status
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            showAlert('error', data.error || 'Failed to send payment link');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('error', 'An error occurred while sending the payment link');
        })
        .finally(() => {
          // Restore button state
          button.innerHTML = originalText;
          button.disabled = false;
        });
      }

      function showAlert(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
        alertDiv.innerHTML = `
          <i class="fa-solid ${icon} me-2"></i>${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the content
        const content = document.querySelector('.col-12.col-lg-10');
        content.insertBefore(alertDiv, content.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, 5000);
      }
</script>
  
{% endblock %}
