{% extends "base.html" %}
{% load static %}
{% block content %}
<style>
  .btn {
    padding: 0.5rem 1rem !important; 
  }

  .cmn-input {
    border-radius: 8px;
    border: 1px solid #F15A29;
    background: var(--white-color);
    padding: 0.5rem 1rem;
    width: 100%;
    margin-bottom: 5px !important;
  }

  /* Make form-check divs clickable */
  .form-check.clickable {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .form-check.clickable:hover {
    background-color: #f8f9fa;
    border-color: #F15A29;
  }
  
  .form-check.clickable:has(input:checked) {
    background-color: #e3f2fd;
    border-color: #F15A29;
  }

  /* Frequency Section Styles */
  .frequency-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .frequency-btn {
    padding: 12px 20px;
    border: 1px solid #F15A29;
    background: white;
    color: #666;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
    min-width: 100px;
  }

  .frequency-btn.active {
    background: #F15A29;
    color: white;
    border-color: #F15A29;
  }

  .frequency-btn:hover {
    border-color: #F15A29;
    color: #F15A29;
  }

  .frequency-btn.active:hover {
    background: #F15A29;
    color: white;
  }

  /* Calendar Navigation Styles */
  .calendar-navigation {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .nav-arrow {
    width: 40px;
    height: 40px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  .nav-arrow:hover {
    background: #f8f9fa;
    border-color: #F15A29;
  }

  .calendar-dates {
    display: flex;
    gap: 15px;
    flex-wrap: 1;
    justify-content: center;
  }

  .date-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    min-width: 60px;
  }

  .date-item:hover {
    border-color: #F15A29;
  }

  .date-item.selected {
    border-color: #F15A29;
    background: #f8f8ff;
  }

  .date-icon {
    font-size: 16px;
    color: #666;
    margin-bottom: 5px;
  }

  .date-day {
    font-size: 12px;
    color: #999;
    font-weight: 500;
  }

  .date-number {
    font-size: 14px;
    font-weight: 600;
    color: #333;
  }

  /* Time Slots Styles */
  .time-slots {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 20px;
  }

  .time-slot {
    padding: 10px 15px;
    border: 2px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s;
    font-size: 14px;
    font-weight: 500;
  }

  .time-slot:hover {
    border-color: #F15A29;
    color: #F15A29;
  }

  .time-slot.selected {
    background: #F15A29;
    color: white;
    border-color: #F15A29;
  }

  .time-slot.unavailable {
    background: #f8f9fa;
    color: #999;
    cursor: not-allowed;
    border-color: #eee;
  }

  .time-slot.unavailable:hover {
    border-color: #eee;
    color: #999;
  }

  select.cmn-input {
    appearance: none;         /* Remove native styling */
    -webkit-appearance: none; /* Safari */
    -moz-appearance: none;    /* Firefox */
    background-color: #fff;
    color: #333;
    padding: 0.5rem 1rem;
    border: 1px solid #F15A29;
    border-radius: 8px;
    font-size: 1rem;
  
    /* Custom dropdown arrow */
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='gray' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1rem;
  }
  
  /* Optional: add right padding so text doesn't overlap arrow */
  select.cmn-input {
    padding-right: 2.5rem;
  }

  
    #stickySummary.fixed {
      position: fixed;
      top: 80px; /* adjust for your navbar */
      z-index: 1000;
    }
    
    #stickySummaryWrapper {
      position: relative;
    }
    
    @media (max-width: 991px) {
      #stickySummary.fixed {
        position: static;
        width: 100%;
      }
    }
    
  </style>

<!-- common banner -->
<section class="common-banner" style="position: relative;">
    <div class="bg-layer" style="background: url({% static '/assets/images/background/common-banner-bg.jpg' %});"></div>
    <div class="common-banner-content">
        <h3>Cleaning Booking</h3>
        <div class="breadcrumb">
            <ul>
              <li class="breadcrumb-item active"><a href="{% url 'home' %}">Home</a></li>
              <li class="breadcrumb-item"><i class="fa-solid fa-angles-right"></i> Cleaning Booking</li>
            </ul>
        </div>
      {% if user.is_authenticated %}
        <a class="btn-1" href="{% url 'request_cleaning_booking' %}">Book Home Cleaning</a>
      {% else %}
        <a class="btn-1" href="{% url 'cleaning_booking' %}">Book Home Cleaning</a>
      {% endif %}
        {% if user.is_authenticated %}
          <a class="btn-1" href="{% url 'office_cleaning_booking' %}">Book Office Cleaning</a>
        {% else %}
          <a class="btn-1" href="{% url 'office_cleaning_booking' %}">Book Office Cleaning</a>
        {% endif %}
        <!-- {% if user.is_authenticated %}
          <a class="btn-1" href="{% url 'request_handyman_booking' %}">Book Handyman</a>
        {% else %}
          <a class="btn-1" href="{% url 'handyman_booking' %}">Book Handyman</a>
        {% endif %} -->
    </div>
  </section>
  <!-- common banner -->
  


<section class="mb-4">
<div class="container">
<div class="row"> 
  <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center mb-4">
    <p class="mb-2 mb-md-0 me-md-4" style="font-size:17px;">Manage existing bookings or re-book a clean.</p>
    <div class="d-flex flex-row gap-2">
      <a href="{% url 'login' %}" class="btn btn-outline-primary">Sign In</a>
      <a href="{% url 'register' %}" class="btn btn-primary">Sign Up</a>
    </div>
  </div>
  <h3 class="mb-0">Book Home Cleaning</h3>
    <p>Get professional cleaning services for your home.</p>
  <h3>Recommended number of cleaners and time according to square footage and type of service.</h3>
              <div class="table-responsive mt-4">
                <table class="table table-clean text-center align-middle">
                  <thead class="table-light">
                    <tr>
                      <th class="text-start" style="min-width: 200px;">Type of Service</th>
                      <th>1000–1500<br><small>SQ FT</small></th>
                      <th>1500–2000<br><small>SQ FT</small></th>
                      <th>2000–2500<br><small>SQ FT</small></th>
                      <th>2500–3000<br><small>SQ FT</small></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <th class="text-start">Post Renovation Cleaning</th>
                      <td>3C × 6 hrs</td>
                      <td>3C × 8 hrs</td>
                      <td>4C × 8 hrs</td>
                      <td>5C × 8 hrs</td>
                    </tr>
                    <tr>
                      <th class="text-start">Deep Cleaning</th>
                      <td>2C × 5 hrs</td>
                      <td>3C × 5 hrs</td>
                      <td>3C × 7 hrs</td>
                      <td>3C × 8 hrs</td>
                    </tr>
                    <tr>
                      <th class="text-start">Move In / Move Out</th>
                      <td>2C × 5 hrs</td>
                      <td>3C × 5 hrs</td>
                      <td>3C × 7 hrs</td>
                      <td>3C × 8 hrs</td>
                    </tr>
                    <tr>
                      <th class="text-start">Regular Cleaning</th>
                      <td>2C × 3 hrs</td>
                      <td>2C × 5 hrs</td>
                      <td>2C × 7 hrs</td>
                      <td>2C × 8 hrs</td>
                    </tr>
                  </tbody>
                </table>
              </div>
    
    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center mb-4">
      <h4 style="color: #666; padding-top: 20px;">Tell Us About Your Cleaning</h4>
    </div>
    

    
      
  <form method="post" id="quoteForm">
    {% csrf_token %}
    <div class="row">
      <div class="col-lg-8">
        

    <!-- Errors -->
    {% if form.errors %}
      <div class="alert alert-danger rounded shadow-sm">
        <ul class="mb-0">
          {% for field in form.visible_fields %}
            {% for error in field.errors %}
              <li>{{ field.label }}: {{ error }}</li>
            {% endfor %}
          {% endfor %}
  
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
  {% endif %}
  
    <input type="hidden" name="hours_requested" id="hidden_hours_requested">
    <input type="hidden" name="num_cleaners" id="hidden_num_cleaners">
    <input type="hidden" name="cleaning_type" id="hidden_cleaning_type">
    <input type="hidden" name="service_cat" value="{{ service_cat.id }}">
    
    <!-- Django form fields for date and hour (hidden) -->
    <div style="display: none;">
      {{ form.date }}
      {{ form.hour }}
    </div>
  
    <!-- Step 1: Choose Service Type -->
    <div class="step mb-4" id="step1">
        <div class="col-12">
          <div class="form-group">
            <label for="id_square_feet_options">Square Feet</label>
            <select name="square_feet_options" id="id_square_feet_options" class="cmn-input">
              {% for option in form.fields.square_feet_options.queryset %}
                <option value="{{ option.id }}" data-price="{{ option.price }}">{{ option.name }}</option>
              {% endfor %}
            </select>
          </div>
  
        <div class="form-group">
          <label for="id_home_types">Home Type</label>
          <select name="home_types" id="id_home_types" class="cmn-input">
            {% for option in form.fields.home_types.queryset %}
              <option value="{{ option.id }}"
                      data-price="{{ option.price }}"
                      data-time="{{ option.extra_minutes }}">
                {{ option.name }} (${{ option.price }})
              </option>
            {% endfor %}
          </select>
        </div>
  
        <div id="cleaningExtrasContainer" class="mb-4">
          <h4 class="mt-4">Select Optional Extras</h4>
          <div class="row">
            {% for extra in cleaning_extras %}
              <div class="col-12 col-md-6 mb-2">
                <div class="form-check p-3 border rounded shadow-sm h-100 clickable" onclick="document.getElementById('extra{{ extra.id }}').click()">
                  <input 
                    class="form-check-input extra-checkbox" 
                    type="checkbox" 
                    id="extra{{ extra.id }}" 
                    name="extras" 
                    value="{{ extra.id }}" 
                    data-price="{{ extra.price }}" 
                    data-time="{{ extra.extra_minutes }}"
                  />
                  <label class="form-check-label ms-2" for="extra{{ extra.id }}">
                    {{ extra.name }} <small class="text-muted">(+${{ extra.price }})</small>
                  </label>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  
    <!-- Large Home Options -->
    <div id="largeHomeOptions" class="mb-4" style="display: none;">
      <h4>Large Home Cleaning Details</h4>
      <div class="row">
        <div class="col-12">
          <select name="cleaning_type" class="cmn-input">
            <option value="">Select Cleaning Type</option>
            <option value="1000-1500 (Regular)" selected>1000–1500 sq.ft (Regular Cleaning)</option>
            <option value="1000-1500 (Deep)">1000–1500 sq.ft (Deep Cleaning)</option>
            <option value="1000-1500 (Move)">1000–1500 sq.ft (Move In/Out Cleaning)</option>
            <option value="1000-1500 (Post)">1000–1500 sq.ft (Post Renovation)</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <select name="num_cleaners" class="cmn-input">
            <option value="1">1 Cleaner</option>
            <option value="2" selected>2 Cleaners</option>
            <option value="3">3 Cleaners</option>
          </select>
        </div>
        <div class="col-6">
          <select name="est_hours" class="cmn-input">
            <option value=""># of Hours</option>
            <option value="2">2 Hours</option>
            <option value="3" selected>3 Hours</option>
            <option value="4">4 Hours</option>
            <option value="5">5 Hours</option>
            <option value="6">6 Hours</option>
            <option value="7">7 Hours</option>
            <option value="8">8 Hours</option>
          </select>
        </div>
      </div>
    </div>
  
    <!-- Step 3: Contact Info -->
    <div class="step hidden-step" id="step3">
      <h4>Contact Info</h4>
          {{ form.name }}
          {{ form.email }}
          {{ form.phone }}
      {{ form.city }}
      {{ form.state }}
      <div class="row">
        <div class="col-9">
            {{ form.address }}
        </div>
        <div class="col-3">
            {{ form.apartment }}
        </div>
      </div>
      {{ form.zip_code }}
  
  <!-- Property Access and Conditions -->
  <div class="row g-3 mt-3">
 
    
    <!-- How to get in -->
    <div class="col-12">
      <h4>How will we get into your home?</h4>
      <div class="row">
        <div class="col-12 col-md-6 mb-2">
          <div class="form-check p-3 border rounded shadow-sm h-100 clickable" onclick="document.getElementById('get_in_at_home').click()">
            <input class="form-check-input get-in-checkbox" type="checkbox" id="get_in_at_home" name="get_in" value="at_home">
            <label class="form-check-label ms-2" for="get_in_at_home">
              <i class="fa-solid fa-house me-2"></i>I'll be at home
            </label>
          </div>
        </div>
        <div class="col-12 col-md-6 mb-2">
          <div class="form-check p-3 border rounded shadow-sm h-100 clickable" onclick="document.getElementById('get_in_doorman').click()">
            <input class="form-check-input get-in-checkbox" type="checkbox" id="get_in_doorman" name="get_in" value="doorman">
            <label class="form-check-label ms-2" for="get_in_doorman">
              <i class="fa-solid fa-door-open me-2"></i>The key is with doorman
            </label>
          </div>
        </div>
        <div class="col-12 col-md-6 mb-2">
          <div class="form-check p-3 border rounded shadow-sm h-100 clickable" onclick="document.getElementById('get_in_lockbox').click()">
            <input class="form-check-input get-in-checkbox" type="checkbox" id="get_in_lockbox" name="get_in" value="lockbox">
            <label class="form-check-label ms-2" for="get_in_lockbox">
              <i class="fa-solid fa-lock me-2"></i>Lockbox on premises
            </label>
          </div>
        </div>
        <div class="col-12 col-md-6 mb-2">
          <div class="form-check p-3 border rounded shadow-sm h-100 clickable" onclick="document.getElementById('get_in_call').click()">
            <input class="form-check-input get-in-checkbox" type="checkbox" id="get_in_call" name="get_in" value="call_organize">
            <label class="form-check-label ms-2" for="get_in_call">
              <i class="fa-solid fa-phone me-2"></i>Call to organize
            </label>
          </div>
        </div>
        <div class="col-12 col-md-6 mb-2">
          <div class="form-check p-3 border rounded shadow-sm h-100 clickable" onclick="document.getElementById('get_in_other').click()">
            <input class="form-check-input get-in-checkbox" type="checkbox" id="get_in_other" name="get_in" value="other">
            <label class="form-check-label ms-2" for="get_in_other">
              <i class="fa-solid fa-ellipsis me-2"></i>Other
            </label>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Parking instructions -->
    <div class="col-12">
      <label for="parking" class="form-label">Parking Instructions</label>
      <textarea name="parking" id="parking" class="cmn-input" rows="3" placeholder="Please provide parking instructions for our cleaning team..."></textarea>
    </div>
  
    <!-- Pet information -->
    <div class="col-12">
      <h4 class="mt-4">Do you have any pets?</h4>
      <div class="row">
        <div class="col-12 col-md-6 mb-2">
          <div class="form-check p-3 border rounded shadow-sm h-100 clickable" onclick="document.getElementById('pet_cat').click()">
            <input class="form-check-input pet-checkbox" type="checkbox" id="pet_cat" name="pet" value="cat">
            <label class="form-check-label ms-2" for="pet_cat">
              <i class="fa-solid fa-cat me-2"></i>Cat
            </label>
          </div>
        </div>
        <div class="col-12 col-md-6 mb-2">
          <div class="form-check p-3 border rounded shadow-sm h-100 clickable" onclick="document.getElementById('pet_dog').click()">
            <input class="form-check-input pet-checkbox" type="checkbox" id="pet_dog" name="pet" value="dog">
            <label class="form-check-label ms-2" for="pet_dog">
              <i class="fa-solid fa-dog me-2"></i>Dog
            </label>
          </div>
        </div>
        <div class="col-12 col-md-6 mb-2">
          <div class="form-check p-3 border rounded shadow-sm h-100 clickable" onclick="document.getElementById('pet_both').click()">
            <input class="form-check-input pet-checkbox" type="checkbox" id="pet_both" name="pet" value="both">
            <label class="form-check-label ms-2" for="pet_both">
              <i class="fa-solid fa-paw me-2"></i>Both
            </label>
          </div>
        </div>
        <div class="col-12 col-md-6 mb-2">
          <div class="form-check p-3 border rounded shadow-sm h-100 clickable" onclick="document.getElementById('pet_other').click()">
            <input class="form-check-input pet-checkbox" type="checkbox" id="pet_other" name="pet" value="other">
            <label class="form-check-label ms-2" for="pet_other">
              <i class="fa-solid fa-ellipsis me-2"></i>Other
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  
    <!-- Step 2: Schedule Info -->
    <div class="step hidden-step" id="step2">
      <h4 class="mt-4 mb-3">Schedule</h4>
      
      <!-- Cleaning Frequency Section -->
      <div class="frequency-section mb-4">
        <h5>How often would you like us to clean?</h5>
        <p class="text-muted mb-3">Save With Our Cleany Loyalty Program! (Discount applied on 2nd cleaning and onward)</p>
        
        <div class="frequency-buttons">
          <button type="button" class="frequency-btn active" data-frequency="one_time" data-discount="0">
            One time
          </button>
          <button type="button" class="frequency-btn" data-frequency="daily" data-discount="20">
            Daily - 20% Off
          </button>
          <button type="button" class="frequency-btn" data-frequency="weekly" data-discount="15">
            Weekly 15% Off
          </button>
          <button type="button" class="frequency-btn" data-frequency="bi_weekly" data-discount="10">
            Bi Weekly 10% Off
          </button>
          <button type="button" class="frequency-btn" data-frequency="monthly" data-discount="5">
            Monthly 5% Off
          </button>
          </div>
        <input type="hidden" name="cleaning_frequency" id="cleaning_frequency" value="one_time">
        <input type="hidden" name="frequency_discount" id="frequency_discount" value="0">
        </div>
      
      <!-- Date of Service Section -->
      <div class="date-section mb-4">
        <h5>Date of service</h5>
        <p class="text-muted mb-3">For recurring services, each one will commence on the same day and time as selected for the first service.</p>
        
        <!-- Calendar and Time Selection -->
        <div class="calendar-section">
          <div class="calendar-navigation mb-3">
            <button type="button" class="nav-arrow" id="prev_week">
              <i class="fa-solid fa-chevron-left"></i>
            </button>
            <div class="calendar-dates" id="calendar_dates">
              <!-- Calendar dates will be populated by JavaScript -->
          </div>
            <button type="button" class="nav-arrow" id="next_week">
              <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
      
          <div class="time-slots" id="time_slots">
            <!-- Time slots will be populated by JavaScript -->
        </div>
      </div>
      
        <!-- Hidden form fields for compatibility -->
        <input type="hidden" name="selected_date" id="selected_date">
        <input type="hidden" name="selected_time" id="selected_time">
        <input type="hidden" name="recurrence_pattern" id="recurrence_pattern" value="one_time">
      </div>
  
      {{ form.job_description.label_tag }}
      {{ form.job_description }}
    </div>
       <!-- Terms -->
       <div class="checkbox-wrap mb-4 mt-4">
        <input type="checkbox" id="terms" required>
        <label for="terms">I agree with all the terms & conditions</label>
    </div>

    <!-- Submit Button -->
    <button type="submit" class="btn-1 w-100">Book Service</button>
  </div>
  <div class="col-lg-4">
    <div id="stickySummaryWrapper">
      <div id="stickySummary" class="service-summary mt-4 p-3 border rounded shadow-sm bg-white">
        <div id="summary-items" class="mb-3"></div>
  
        <div class="d-flex align-items-center mb-1">
          <i class="fa-solid fa-calendar-days me-2 text-muted"></i>
          <span id="summary-date">–</span>
        </div>
        <div class="d-flex align-items-center mb-1">
          <i class="fa-regular fa-clock me-2 text-muted"></i>
          <span id="summary-duration">–</span>
        </div>
        <div class="d-flex align-items-center mb-3">
          <i class="fa-solid fa-rotate me-2 text-muted"></i>
          <span id="summary-recurrence">–</span>
        </div>
  
        <hr>
  
        <div class="d-flex justify-content-between">
          <strong>SUB-TOTAL</strong>
          <strong>$<span id="subtotalPrice">0.00</span></strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>SALES TAX</span>
          <span>$<span id="salesTax">0.00</span></span>
        </div>
        <h5 class="mt-4">Discount Code</h5>
          <div class="mb-3">
            <input type="text" id="gift_card_code" name="gift_card_code" class="cmn-input w-100" placeholder="Enter Gift Card or Discount Code">
          </div>
          <div class="d-flex gap-2">
            <button type="button" id="applyGiftCard" class="btn btn-primary w-100">Apply</button>
            <button type="button" id="removeGiftCard" class="btn btn-outline-danger w-100">Remove</button>
          </div>
        <div id="giftCardApplied" style="display:none;" class="d-flex justify-content-between mt-2">
          <strong>Discount:</strong>
          <strong id="giftCardAmount" style="color: green;">0.00</strong>
        </div>
        
        <div class="d-flex justify-content-between mt-2" style="font-size: 1.3rem;">
          <strong>TOTAL</strong>
          <strong style="color: orange;">$<span id="totalPrice">0.00</span></strong>
        </div>
  
      </div>
    </div>
  </div>
</div>
</div>
    </div>
  </form>
</div>
</div>
</section>
  
  
  
  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="{% static 'assets/js/giftcard.js' %}"></script>
  <script>
  // ================================
  // FLATPICKR + FORM LOGIC + PRICING ENGINE
  // ================================
  document.addEventListener("DOMContentLoaded", function () {
    // === Calendar and Time Selection Logic ===
    let currentWeekStart = new Date();
    currentWeekStart.setDate(currentWeekStart.getDate() + 2);
    let selectedDate = null;
    let selectedTime = null;

    function renderCalendar() {
      console.log('🔍 renderCalendar called');
      const calendarDates = document.getElementById('calendar_dates');
      if (!calendarDates) {
        console.log('❌ calendar_dates element not found');
        return;
      }
      console.log('🔍 calendar_dates found, rendering...');
      
      calendarDates.innerHTML = '';
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(currentWeekStart.getDate() + i);
        
        const dayNames = ['Su', 'M', 'Tu', 'W', 'Th', 'F', 'Sa'];
        const dayName = dayNames[date.getDay()];
        const dateNumber = date.getDate();
        const month = date.getMonth() + 1;
        
        const dateItem = document.createElement('div');
        dateItem.className = 'date-item';
        
        // Check if this date is the selected date
        if (selectedDate && date.toDateString() === selectedDate.toDateString()) {
          dateItem.classList.add('selected');
        }
        
        dateItem.innerHTML = `
          <div class="date-icon">
            <i class="fa-solid fa-calendar"></i>
          </div>
          <div class="date-day">${dayName}</div>
          <div class="date-number">${month}/${dateNumber.toString().padStart(2, '0')}</div>
        `;
        
        dateItem.addEventListener('click', () => selectDate(date));
        calendarDates.appendChild(dateItem);
      }
      
      // If no date is selected, select the first date by default
      if (!selectedDate) {
        selectDate(new Date(currentWeekStart));
      }
    }

      function selectDate(date) {
    selectedDate = date;
    
    document.querySelectorAll('.date-item').forEach(item => {
      item.classList.remove('selected');
    });
    event.target.closest('.date-item').classList.add('selected');
    
    const dateValue = date.toISOString().split('T')[0];
    document.getElementById('selected_date').value = dateValue;
    
    // Also update Django form field
    const dateField = document.getElementById("id_date");
    if (dateField) {
      dateField.value = dateValue;
      console.log('🔍 Updated Django date field to:', dateValue);
    }
    
    loadTimeSlots(date);
    updatePrice();
  }

    function loadTimeSlots(date) {
      const timeSlots = document.getElementById('time_slots');
      if (!timeSlots) {
        console.log('❌ Time slots container not found');
        return;
      }
      
      timeSlots.innerHTML = '';
      
      // Get the hours requested from the form
      let hoursRequested = 3; // default fallback
      
      // Try to get hours from large home options
      const hoursField = document.querySelector('select[name="est_hours"]');
      if (hoursField && hoursField.value) {
        hoursRequested = parseFloat(hoursField.value) || 3;
      } else {
        // For small homes, calculate from home type + extras
        const homeSelect = document.getElementById("id_home_types");
        let totalMinutes = parseInt(homeSelect?.selectedOptions[0]?.dataset.time || "180");
        
        document.querySelectorAll(".extra-checkbox:checked").forEach(cb => {
          totalMinutes += parseInt(cb.dataset.time || "0") || 0;
        });
        
        hoursRequested = Math.ceil(totalMinutes / 60);
      }
      
      // Fetch available hours from API
      const selectedDate = date.toISOString().split('T')[0];
      
      console.log('🔍 Loading time slots for:', { selectedDate, hoursRequested });
      
      timeSlots.innerHTML = '<div class="text-center text-muted">Loading available times...</div>';
      
      fetch(`/quotes/api/available-hours/?date=${selectedDate}&hours=${hoursRequested}`)
        .then(response => response.json())
        .then(data => {
          console.log('🔍 Available hours API response:', data);
          timeSlots.innerHTML = '';
          
          if (!data.available_hours || data.available_hours.length === 0) {
            timeSlots.innerHTML = '<div class="text-center text-muted">No available times for this date</div>';
            return;
          }
          
          // Create time slots from available hours
          data.available_hours.forEach((timeStr, index) => {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            
            // Parse time string (e.g., "14:00" to "2:00 PM")
            const [hour, minute] = timeStr.split(':').map(Number);
            const ampm = hour < 12 ? 'am' : 'pm';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            const displayTime = `${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`;
            
            timeSlot.textContent = displayTime;
            timeSlot.dataset.time = timeStr; // Store original time for form submission
            
            timeSlot.addEventListener('click', () => selectTimeSlot(timeSlot, hour, timeStr));
            timeSlots.appendChild(timeSlot);
          });
          
          // Select first available time slot by default
          if (timeSlots.children.length > 0) {
            selectTimeSlot(timeSlots.children[0], parseInt(data.available_hours[0].split(':')[0]), data.available_hours[0]);
          }
        })
        .catch(error => {
          console.error('❌ Failed to fetch available hours:', error);
          timeSlots.innerHTML = '<div class="text-center text-muted">Failed to load available times</div>';
          
          // Fallback to showing all time slots if API fails
          const dayOfWeek = date.getDay();
          let startHour = 8;
          let endHour = 18;
          
          if (dayOfWeek === 0 || dayOfWeek === 6) {
            startHour = 8;
            endHour = 18;
          } else {
            startHour = 11;
            endHour = 18;
          }
          
          for (let hour = startHour; hour <= endHour; hour++) {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.textContent = `${hour}:00${hour < 12 ? 'am' : hour === 12 ? 'pm' : 'pm'}`;
            timeSlot.dataset.time = `${hour.toString().padStart(2, '0')}:00`;
            
            timeSlot.addEventListener('click', () => selectTimeSlot(timeSlot, hour, `${hour.toString().padStart(2, '0')}:00`));
            timeSlots.appendChild(timeSlot);
          }
          
          if (timeSlots.children.length > 0) {
            selectTimeSlot(timeSlots.children[0], startHour, `${startHour.toString().padStart(2, '0')}:00`);
          }
        });
    }

    function selectTimeSlot(slot, hour, timeStr) {
      selectedTime = hour;
      
      document.querySelectorAll('.time-slot').forEach(s => {
        s.classList.remove('selected');
      });
      slot.classList.add('selected');
      
      document.getElementById('selected_time').value = timeStr;
      
      // Also update Django form field
      const hourField = document.getElementById("id_hour");
      if (hourField) {
        hourField.value = timeStr;
        console.log('🔍 Updated Django hour field to:', timeStr);
      }
      
      updatePrice();
    }

    // Navigation arrows
    const prevWeekBtn = document.getElementById('prev_week');
    const nextWeekBtn = document.getElementById('next_week');
    
    if (prevWeekBtn) {
      prevWeekBtn.addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        renderCalendar();
      });
    }
    
    if (nextWeekBtn) {
      nextWeekBtn.addEventListener('click', () => {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        renderCalendar();
      });
    }

    // === Frequency Button Logic ===
    const frequencyButtons = document.querySelectorAll('.frequency-section .frequency-btn');
    const frequencyInput = document.getElementById('cleaning_frequency');
    const discountInput = document.getElementById('frequency_discount');

    frequencyButtons.forEach(button => {
      button.addEventListener('click', function() {
        frequencyButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        frequencyInput.value = this.dataset.frequency;
        discountInput.value = this.dataset.discount;
        updatePrice();
      });
    });

    // Calendar will be initialized later in the initialization sequence

    // === Flatpickr Setup (keep for backward compatibility) ===
    const dateField = document.getElementById("id_date");
    if (dateField) {
      flatpickr("#id_date", {
        dateFormat: "Y-m-d",
        minDate: new Date().fp_incr(2),
        defaultDate: new Date().fp_incr(2),
        disableMobile: true
      });
    }
  
    // === Shared DOM Elements ===
    const hourSelect = document.getElementById("id_hour");
    const hoursField = document.querySelector('select[name="est_hours"]');
    const sqftSelect = document.getElementById("id_square_feet_options");
    const cleanerSelect = document.querySelector('select[name="num_cleaners"]');
    const cleaningTypeSelect = document.querySelector('select[name="cleaning_type"]');
    const homeTypeGroup = document.getElementById("id_home_types")?.closest(".form-group");
    const extrasContainer = document.getElementById("cleaningExtrasContainer");
    const largeHomeOptions = document.getElementById("largeHomeOptions");
  
    function isSmallHomeSelected() {
      const selectedOption = sqftSelect?.selectedOptions[0];
      if (!selectedOption) return false;
      return selectedOption.textContent.toLowerCase().includes("under 1000");
    }
  
    // === Load available hours dynamically ===
    function fetchAvailableHours() {
      const selectedDate = dateField?.value;
      let selectedHours = 3; // default fallback
  
      if (largeHomeOptions?.offsetParent !== null) {
        // Use selected value for large homes
        selectedHours = parseInt(hoursField?.value || "3");
      } else {
        // Use home type + extras for small homes
        const homeSelect = document.getElementById("id_home_types");
        let totalMinutes = parseInt(homeSelect?.selectedOptions[0]?.dataset.time || "0");
  
    document.querySelectorAll(".extra-checkbox:checked").forEach(cb => {
      totalMinutes += parseInt(cb.dataset.time || "0") || 0;
    });
  
    selectedHours = Math.ceil(totalMinutes / 60); // round up to next full hour
  }
  
      if (!selectedDate || isNaN(selectedHours)) return;
  
      hourSelect.innerHTML = "<option>Loading...</option>";
      hourSelect.disabled = true;
  
      fetch(`/quotes/api/available-hours/?date=${selectedDate}&hours=${selectedHours}`)
        .then(response => response.json())
        .then(data => {
          hourSelect.innerHTML = "";
          hourSelect.disabled = false;
  
          if (!data.available_hours || data.available_hours.length === 0) {
            hourSelect.innerHTML = "<option disabled selected>No available time</option>";
          } else {
            data.available_hours.forEach((hour, index) => {
              const option = document.createElement("option");
              option.value = hour;
              option.textContent = hour;
              if (index === 0) option.selected = true;
              hourSelect.appendChild(option);
            });
  
            if (data.available_hours.length === 1) {
              hourSelect.value = data.available_hours[0];
            }
          }
  
          updatePrice();
        })
        .catch((err) => {
          console.error("❌ Failed to fetch available hours:", err);
          hourSelect.innerHTML = "<option value=''>Failed to load</option>";
          hourSelect.disabled = false;
        });
    }
  
    // === UI Defaults ===
    function setDefaultSquareFeet() {
      for (let i = 0; i < sqftSelect.options.length; i++) {
        if (sqftSelect.options[i].textContent.toLowerCase().includes("under 1000")) {
          sqftSelect.selectedIndex = i;
          break;
        }
      }
    }
  
    function toggleHomeAndExtras() {
      const selectedOption = sqftSelect?.selectedOptions[0];
      if (!selectedOption) return;
  
      const selectedName = selectedOption.textContent.trim().toLowerCase();
      const isUnder1000 = selectedName.includes("under 1000");
      
      console.log('🔍 toggleHomeAndExtras called:', { selectedName, isUnder1000 });
  
      if (isUnder1000) {
        homeTypeGroup.style.display = "";
        extrasContainer.style.display = "";
        largeHomeOptions.style.display = "none";
      } else {
        homeTypeGroup.style.display = "none";
        extrasContainer.style.display = "none";
        largeHomeOptions.style.display = "";

        // Clear extras for large homes since they're not available
        document.querySelectorAll(".extra-checkbox").forEach(cb => {
          cb.checked = false;
        });

        if (selectedName.includes("1500–2000") || selectedName.includes("1500-2000")) {
          cleaningTypeSelect.innerHTML = `
            <option value="">Select Cleaning Type</option>
            <option value="1500-2000 (Regular)" selected>1500–2000 sq.ft (Regular Cleaning)</option>
            <option value="1500-2000 (Deep)">1500–2000 sq.ft (Deep Cleaning)</option>
            <option value="1500-2000 (Move)">1500–2000 sq.ft (Move In/Out Cleaning)</option>
            <option value="1500-2000 (Post)">1500–2000 sq.ft (Post Renovation)</option>
          `;
          cleanerSelect.value = "2";
          hoursField.value = "5";
        } else if (selectedName.includes("custom")) {
          cleaningTypeSelect.innerHTML = `
            <option value="custom_cleaning" selected>Hourly Service 58$ per hour/per cleaner</option>
          `;
          cleanerSelect.value = "2";
          hoursField.value = "5";
        } else if (selectedName.includes("renovation")) {
          cleaningTypeSelect.innerHTML = `
            <option value="post_renovation" selected>Hourly Service 63$ per hour/per cleaner</option>
          `;
          cleanerSelect.value = "2";
          hoursField.value = "5";
        } else {
          cleaningTypeSelect.innerHTML = `
            <option value="">Select Cleaning Type</option>
            <option value="1000-1500 (Regular)" selected>1000–1500 sq.ft (Regular Cleaning)</option>
            <option value="1000-1500 (Deep)">1000–1500 sq.ft (Deep Cleaning)</option>
            <option value="1000-1500 (Move)">1000–1500 sq.ft (Move In/Out Cleaning)</option>
            <option value="1000-1500 (Post)">1000–1500 sq.ft (Post Renovation)</option>
          `;
          cleanerSelect.value = "2";
          hoursField.value = "3";
        }
  
        cleaningTypeSelect?.dispatchEvent(new Event("change"));
      }
  
      updatePrice();
    }
  
    cleaningTypeSelect?.addEventListener("change", function () {
      const value = this.value.toLowerCase();
  
      if (value.includes("regular")) {
        cleanerSelect.value = value.includes("1500-2000") ? "2" : "2";
        hoursField.value = value.includes("1500-2000") ? "5" : "3";
      } else if (value.includes("deep")) {
        cleanerSelect.value = value.includes("1500-2000") ? "3" : "2";
        hoursField.value = "5";
      } else if (value.includes("move")) {
        cleanerSelect.value = value.includes("1500-2000") ? "3" : "2";
        hoursField.value = "5";
      } else if (value.includes("post")) {
        cleanerSelect.value = "3";
        hoursField.value = value.includes("1500-2000") ? "8" : "6";
      }
  
      updatePrice();
    });

    document.getElementById("applyGiftCard")?.addEventListener("click", () => {
      const code = document.getElementById("gift_card_code")?.value.trim();
      applyGiftCardOrDiscount(code, () => {
        updatePrice();
      });
    });

    document.getElementById("removeGiftCard")?.addEventListener("click", () => {
      // Clear all discount/gift states
      giftCardActive = false;
      giftCardBalance = 0;
      appliedGiftCardAmount = 0;
      discountCode = null;
      appliedDiscountAmount = 0;
    
      // Clear input field
      document.getElementById("gift_card_code").value = "";
    
      // Update price and UI
      updatePrice();
    
      // Optional: hide applied discount line
      const el = document.getElementById("giftCardApplied");
      if (el) el.style.display = "none";
    });
  
    // === Set Default Values ===
    function setDefaultValues() {
      console.log('🔍 setDefaultValues called');
      
      // Set default date (2 days from now)
      const defaultDate = new Date();
      defaultDate.setDate(defaultDate.getDate() + 2);
      selectedDate = defaultDate;
      console.log('🔍 Set selected date to:', selectedDate);
      
      // Set default time (9:00 AM)
      selectedTime = 9;
      console.log('🔍 Set selected time to:', selectedTime);
      
      // Update hidden fields with defaults
      const dateValue = defaultDate.toISOString().split('T')[0];
      const timeValue = '09:00';
      
      document.getElementById('selected_date').value = dateValue;
      document.getElementById('selected_time').value = timeValue;
      
      // Also update Django form fields
      const dateField = document.getElementById("id_date");
      const hourField = document.getElementById("id_hour");
      
      if (dateField) {
        dateField.value = dateValue;
        console.log('🔍 Set Django date field to:', dateValue);
      }
      
      if (hourField) {
        hourField.value = timeValue;
        console.log('🔍 Set Django hour field to:', timeValue);
      }
      
      console.log('🔍 Set hidden fields - date:', dateValue, 'time:', timeValue);
    }

    // Run initializers
    setDefaultSquareFeet();
    toggleHomeAndExtras();
    setDefaultValues(); // Set default values first
    renderCalendar(); // Then render calendar with selected date
    updatePrice(); // Finally update the summary
  
    // === Event Bindings ===
    sqftSelect?.addEventListener("change", toggleHomeAndExtras);
    sqftSelect?.addEventListener("change", fetchAvailableHours);
    cleaningTypeSelect?.addEventListener("change", fetchAvailableHours);
    cleanerSelect?.addEventListener("change", fetchAvailableHours);
    hoursField?.addEventListener("change", fetchAvailableHours);
    
    // Add event listener for home type changes
    const homeTypeSelect = document.getElementById("id_home_types");
    if (homeTypeSelect) {
      homeTypeSelect.addEventListener("change", updatePrice);
    }
  
    // Refresh on blur (when user clicks out of the input)
    if (dateField) {
      dateField.addEventListener("change", fetchAvailableHours);
    }
    if (hoursField) {
      hoursField.addEventListener("change", fetchAvailableHours);
    }
  
    document.querySelectorAll(".extra-checkbox").forEach(cb => {
      cb.addEventListener("change", function() {
        console.log('🔍 Extra checkbox changed:', this.checked, this.value, this.dataset.price);
        updatePrice();
      });
    });
    
    // Handle get_in checkboxes (only one can be selected)
    document.querySelectorAll(".get-in-checkbox").forEach(cb => {
      cb.addEventListener("change", function() {
        if (this.checked) {
          // Uncheck all other get_in checkboxes
          document.querySelectorAll(".get-in-checkbox").forEach(otherCb => {
            if (otherCb !== this) {
              otherCb.checked = false;
            }
          });
        }
        updatePrice();
      });
    });
    
    // Handle pet checkboxes (only one can be selected)
    document.querySelectorAll(".pet-checkbox").forEach(cb => {
      cb.addEventListener("change", function() {
        if (this.checked) {
          // Uncheck all other pet checkboxes
          document.querySelectorAll(".pet-checkbox").forEach(otherCb => {
            if (otherCb !== this) {
              otherCb.checked = false;
            }
          });
        }
        updatePrice();
      });
    });
    
    document.querySelectorAll("input, select").forEach(el => {
      el.addEventListener("change", updatePrice);
      el.addEventListener("input", () => {
        if (el.classList.contains("is-invalid") && el.value) {
          el.classList.remove("is-invalid");
        }
      });
    });
    cleanerSelect?.addEventListener("change", updatePrice);
    hoursField?.addEventListener("change", updatePrice);
    cleaningTypeSelect?.addEventListener("change", updatePrice);
  
     // ================================
    // PRICE & SUMMARY CALCULATOR
    // ================================
    function updatePrice() {
      console.log('🔍 updatePrice called');
      let subtotal = 0;
      const sqftPrice = parseFloat(sqftSelect?.selectedOptions[0]?.dataset.price || 0);
      subtotal += sqftPrice;
  
      // Home Type (only if visible)
      if (isSmallHomeSelected()) {
        const homeSelect = document.getElementById("id_home_types");
        const homePrice = parseFloat(homeSelect?.selectedOptions[0]?.dataset.price || 0);
        subtotal += homePrice;
      }
  
      // Extras (always check if any are selected)
      const checkedExtras = document.querySelectorAll(".extra-checkbox:checked");
      console.log('🔍 Processing extras for pricing:', checkedExtras.length);
      checkedExtras.forEach(cb => {
        const price = parseFloat(cb.dataset.price || 0);
        console.log('🔍 Adding extra price:', price);
        subtotal += price;
      });
  
      // Labor cost for large homes
  let laborCost = 0;
  if (largeHomeOptions?.offsetParent !== null) {
    const numCleaners = parseInt(cleanerSelect?.value || 0);
        const estimatedHours = parseFloat(hoursField?.value || 0);
    const cleaningType = cleaningTypeSelect?.value?.toLowerCase() || "";
    let hourlyRate = cleaningType.includes("post") || cleaningType.includes("renovation") ? 63 : 58;
  
    laborCost = numCleaners * estimatedHours * hourlyRate;
    subtotal += laborCost;
  }
      
      // Apply frequency discount
      const frequencyDiscount = parseInt(document.getElementById('frequency_discount')?.value || 0);
      const frequencyDiscountAmount = subtotal * (frequencyDiscount / 100);
      subtotal -= frequencyDiscountAmount;
  
  const taxRate = 0.08875;
const tax = subtotal * taxRate;
let total = subtotal + tax;

let discount = 0;
let discountLabel = "";

// ✅ Apply gift card if active
if (giftCardActive && giftCardBalance > 0) {
  discount = Math.min(giftCardBalance, total);
  appliedGiftCardAmount = discount;
  appliedDiscountAmount = 0;
  discountLabel = "Gift Card";
}

// ✅ Otherwise, apply discount code
else if (discountCode) {
  if (discountCode.type === "fixed") {
    discount = Math.min(discountCode.value, total);
  } else if (discountCode.type === "percent") {
    discount = total * (discountCode.value / 100);
  }
  appliedDiscountAmount = discount;
  appliedGiftCardAmount = 0;
  discountLabel = "Discount";
}

// ✅ Apply the discount to total
total = total - discount;

// ✅ Update the summary UI
const giftEl = document.getElementById("giftCardApplied");
const giftAmtEl = document.getElementById("giftCardAmount");

if (discount > 0 && giftEl && giftAmtEl) {
  giftEl.style.display = "flex";
  giftEl.querySelector("strong").innerText = `${discountLabel}: -$${discount.toFixed(2)}`;
  giftAmtEl.innerText = discount.toFixed(2);
} else if (giftEl) {
  giftEl.style.display = "none";
  giftAmtEl.innerText = "0.00";
}

// ✅ Update the total UI
document.getElementById("subtotalPrice").innerText = subtotal.toFixed(2);
document.getElementById("salesTax").innerText = tax.toFixed(2);
document.getElementById("totalPrice").innerText = total.toFixed(2);
  
      // Update summary items list
      const summaryContainer = document.getElementById("summary-items");
      console.log('🔍 Summary container found:', !!summaryContainer);
      if (summaryContainer) {
      summaryContainer.innerHTML = "";
  
      if (sqftSelect) {
        const sqftLabel = sqftSelect.selectedOptions[0]?.textContent.trim();
        if (sqftPrice > 0) {
          summaryContainer.innerHTML += `
            <div class="d-flex justify-content-between align-items-center mb-1">
              <div><i class="fa-solid fa-house me-2"></i>${sqftLabel}</div>
              <div>$${sqftPrice.toFixed(2)}</div>
            </div>`;
        }
      }
  
      if (isSmallHomeSelected()) {
          console.log('🔍 Small home selected, adding home type to summary');
        const homeSelect = document.getElementById("id_home_types");
        const homeOption = homeSelect?.selectedOptions[0];
        const homeLabel = homeOption?.textContent.trim();
        const homePrice = parseFloat(homeOption?.dataset.price || 0);
          
          console.log('🔍 Home type details:', { homeLabel, homePrice, homeOption });
      
        if (homeLabel && homePrice > 0) {
          summaryContainer.innerHTML += `
            <div class="d-flex justify-content-between align-items-center mb-1 ps-4 text-muted">
              <div>• ${homeLabel}</div>
              <div>$${homePrice.toFixed(2)}</div>
            </div>`;
        }
        } else {
          console.log('🔍 Large home selected, skipping home type');
      }
  
        const checkedExtras = document.querySelectorAll(".extra-checkbox:checked");
        console.log('🔍 Found checked extras:', checkedExtras.length);
        checkedExtras.forEach(cb => {
        const label = cb.nextElementSibling?.textContent?.trim() || "Extra";
        const price = parseFloat(cb.dataset.price || 0).toFixed(2);
          console.log('🔍 Adding extra to summary:', { label, price });
        summaryContainer.innerHTML += `
          <div class="d-flex justify-content-between align-items-center mb-1 ps-4 text-muted">
            <div>• ${label}</div>
            <div>$${price}</div>
          </div>`;
      });
  
      if (largeHomeOptions?.offsetParent !== null && laborCost > 0) {
        const numCleaners = parseInt(cleanerSelect?.value || "0");
        const hours = parseFloat(hoursField?.value || "0");
        const cleaningType = cleaningTypeSelect?.value?.toLowerCase() || "";
        const hourlyRate = cleaningType.includes("post") || cleaningType.includes("renovation") ? 63 : 58;
      
        summaryContainer.innerHTML += `
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div><i class="fa-solid fa-broom me-2"></i>${numCleaners} Cleaners × ${hours} Hours × $${hourlyRate}/hour</div>
            <div>$${laborCost.toFixed(2)}</div>
          </div>`;
      }
  
        // Show frequency discount if applicable
        if (frequencyDiscount > 0) {
          summaryContainer.innerHTML += `
            <div class="d-flex justify-content-between align-items-center mb-1 text-success">
              <div><i class="fa-solid fa-tag me-2"></i>Frequency Discount (${frequencyDiscount}%)</div>
              <div>-$${frequencyDiscountAmount.toFixed(2)}</div>
            </div>`;
        }
      }
  
      // Update schedule info - use new calendar values if available
      let dateVal = document.getElementById("selected_date")?.value || document.getElementById("id_date")?.value || "-";
      let timeVal = document.getElementById("selected_time")?.value || document.getElementById("id_hour")?.value || "-";
      let recurrenceText = document.getElementById("recurrence_pattern")?.value || document.getElementById("id_recurrence_pattern")?.selectedOptions?.[0]?.textContent || "-";

      // Format time display
      if (timeVal && timeVal !== "-") {
        const [hour, minute] = timeVal.split(':').map(Number);
        const ampm = hour < 12 ? 'am' : 'pm';
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        timeVal = `${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`;
      }

      // Format date display
      if (dateVal && dateVal !== "-") {
        const date = new Date(dateVal);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const year = date.getFullYear();
        dateVal = `${month}/${day}/${year}`;
      }

      // Format recurrence text
      const frequencyLabels = {
        'one_time': 'One Time',
        'daily': 'Daily',
        'weekly': 'Weekly',
        'bi_weekly': 'Bi-Weekly',
        'monthly': 'Monthly'
      };
      if (frequencyLabels[recurrenceText]) {
        recurrenceText = frequencyLabels[recurrenceText];
      }
  
      document.getElementById("summary-date").textContent = `${dateVal} @ ${timeVal}`;
      document.getElementById("summary-recurrence").textContent = recurrenceText;
  
      // Calculate and display total duration
  let totalMinutes = 0;
  if (largeHomeOptions?.offsetParent !== null) {
    const estimatedHours = parseFloat(hoursField?.value || "0");
    totalMinutes = estimatedHours * 60;
  } else {
    const homeSelect = document.getElementById("id_home_types");
    const baseMinutes = parseInt(homeSelect?.selectedOptions[0]?.dataset.time || "0");
    totalMinutes += isNaN(baseMinutes) ? 0 : baseMinutes;
  
    document.querySelectorAll(".extra-checkbox:checked").forEach(cb => {
      totalMinutes += parseInt(cb.dataset.time || "0") || 0;
    });
  }
  
      const finalHours = Math.floor(totalMinutes / 60);
      const finalMinutes = totalMinutes % 60;
      const hourLabel = finalHours === 1 ? "Hour" : "Hours";
      const minuteLabel = finalMinutes === 1 ? "Minute" : "Minutes";
      document.getElementById("summary-duration").textContent = `${finalHours} ${hourLabel} ${finalMinutes} ${minuteLabel} (estimated time)`;
    }
  
    function resetSummary() {
      // 1. Reset home type to "Studio"
      const homeTypeSelect = document.getElementById("id_home_types");
      if (homeTypeSelect) {
        for (let i = 0; i < homeTypeSelect.options.length; i++) {
          if (homeTypeSelect.options[i].textContent.toLowerCase().includes("studio")) {
            homeTypeSelect.selectedIndex = i;
            break;
          }
        }
      }
    
      // 2. Uncheck all extras
      document.querySelectorAll(".extra-checkbox").forEach(cb => {
        cb.checked = false;
      });
    
      // 3. Reset date and time
      const today = new Date();
      today.setDate(today.getDate() + 2); // ✅ Add 2 days
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const formattedDateInput = `${yyyy}-${mm}-${dd}`;
      const formattedDateText = `${mm}/${dd}/${yyyy}`;
      const time = "09:00"; // 9:00 AM
    
      const dateInput = document.getElementById("id_date");
      if (dateInput) dateInput.value = formattedDateInput;
    
      const timeInput = document.getElementById("id_hour");
      if (timeInput) timeInput.value = time;
    
      // 4. Reset recurrence to "One Time"
      const recurrenceSelect = document.getElementById("id_recurrence_pattern");
      if (recurrenceSelect) {
        for (let i = 0; i < recurrenceSelect.options.length; i++) {
          if (recurrenceSelect.options[i].textContent.toLowerCase().includes("one time")) {
            recurrenceSelect.selectedIndex = i;
            break;
          }
        }
      }
    
      // 5. Reset duration to base from selected Studio (data-time)
      const selectedOption = homeTypeSelect?.selectedOptions[0];
      let baseMinutes = parseInt(selectedOption?.dataset.time || "180"); // fallback to 3 hrs
    
      const finalHours = Math.floor(baseMinutes / 60);
      const finalMinutes = baseMinutes % 60;
      const hourLabel = finalHours === 1 ? "Hour" : "Hours";
      const minuteLabel = finalMinutes === 1 ? "Minute" : "Minutes";
    
      // 6. Update summary UI
      const price = parseFloat(selectedOption?.dataset.price || "130");
      const taxRate = 0.08875;
      const tax = price * taxRate;
      const total = price + tax;
    
      document.getElementById("summary-items").innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-1 ps-4 text-muted">
          <div>• Studio ($130.00)</div>
          <div>$${price.toFixed(2)}</div>
        </div>`;
    
      document.getElementById("summary-date").textContent = `${formattedDateText} @ 9:00 AM`;
      document.getElementById("summary-duration").textContent = `${finalHours} ${hourLabel} ${finalMinutes} ${minuteLabel} (estimated time)`;
      document.getElementById("summary-recurrence").textContent = "One Time";
    
      document.getElementById("subtotalPrice").innerText = price.toFixed(2);
      document.getElementById("salesTax").innerText = tax.toFixed(2);
      document.getElementById("totalPrice").innerText = total.toFixed(2);
    }
  
    function syncHiddenFields() {
      console.log('🔍 syncHiddenFields called');
      
      // Sync calendar fields with Django form fields
      const selectedDate = document.getElementById('selected_date')?.value;
      const selectedTime = document.getElementById('selected_time')?.value;
      
      console.log('🔍 Syncing calendar values to Django form:', { selectedDate, selectedTime });
      
      // Update Django form fields
      const dateField = document.getElementById("id_date");
      const hourField = document.getElementById("id_hour");
      
      if (dateField && selectedDate) {
        dateField.value = selectedDate;
        console.log('🔍 Set Django date field to:', selectedDate);
      }
      
      if (hourField && selectedTime) {
        hourField.value = selectedTime;
        console.log('🔍 Set Django hour field to:', selectedTime);
      }
      
      // If large home section is visible, use that data
      if (document.getElementById("largeHomeOptions")?.offsetParent !== null) {
        const cleaners = document.querySelector('select[name="num_cleaners"]')?.value;
        const hours = document.querySelector('select[name="est_hours"]')?.value;
        const type = document.querySelector('select[name="cleaning_type"]')?.value;
    
        document.getElementById("hidden_hours_requested").value = hours;
        document.getElementById("hidden_num_cleaners").value = cleaners;
        document.getElementById("hidden_cleaning_type").value = type;
      } else {
        // For small homes: use computed time from summary
        const homeSelect = document.getElementById("id_home_types");
        let totalMinutes = parseInt(homeSelect?.selectedOptions[0]?.dataset.time || "0");
    
        document.querySelectorAll(".extra-checkbox:checked").forEach(cb => {
          totalMinutes += parseInt(cb.dataset.time || "0") || 0;
        });
    
        const roundedHours = Math.ceil(totalMinutes / 60);
    
        document.getElementById("hidden_hours_requested").value = roundedHours;
        document.getElementById("hidden_num_cleaners").value = 1;
        document.getElementById("hidden_cleaning_type").value = ""; // optional
      }
    }
    document.getElementById("quoteForm").addEventListener("submit", function () {
      syncHiddenFields(); // ✅ ensures all values are ready
    });

    document.getElementById("quoteForm").addEventListener("submit", function (e) {
      // Check calendar system values
      const selectedTime = document.getElementById("selected_time")?.value;
      const selectedDate = document.getElementById("selected_date")?.value;
      
      // Check Django form fields
      const djangoDate = document.getElementById("id_date")?.value;
      const djangoHour = document.getElementById("id_hour")?.value;
      
      console.log('🔍 Form validation - Calendar values:', { selectedTime, selectedDate });
      console.log('🔍 Form validation - Django values:', { djangoDate, djangoHour });
      
      // Validate time and date selection (check both calendar and Django fields)
      if (!selectedTime || !selectedDate || !djangoDate || !djangoHour) {
        e.preventDefault();
        alert("❌ Please choose a valid available time slot and date before submitting.");
        return;
      }
      
      console.log('🔍 Form validation passed, submitting...');
    });
  });
  </script>
  
  
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const summary = document.getElementById("stickySummary");
        const wrapper = document.getElementById("stickySummaryWrapper");
      
        const offsetTop = wrapper.offsetTop;
      
        function handleScroll() {
          const wrapperRect = wrapper.getBoundingClientRect();
      
          if (window.scrollY > offsetTop - 80) {
            summary.classList.add("fixed");
            summary.style.width = `${wrapper.offsetWidth}px`; // set exact width
          } else {
            summary.classList.remove("fixed");
            summary.style.width = ""; // reset
          }
        }
      
        window.addEventListener("scroll", handleScroll);
        window.addEventListener("resize", () => {
          if (summary.classList.contains("fixed")) {
            summary.style.width = `${wrapper.offsetWidth}px`;
          }
        });
      });
      </script>
      
{% endblock %}