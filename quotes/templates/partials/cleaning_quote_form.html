<style>
  .summary-font {
    font-size: 20px !important;
  }

  .total-font {
    font-size: 24px !important;
  }

 
</style>

<form method="post" id="quoteForm">
    {% csrf_token %}

    <!-- Step 1: Choose Service Type -->
    <div class="step mb-4" id="step1">

      <div class="row">
        <div class="col-7">
          <!--<div class="form-group">
            {{ form.service.label_tag }}
            {{ form.service }}
          </div> -->
        </div>
        <div class="col-12">
          <div class="form-group">
            <label for="id_square_feet_options">Square Feet</label>
            <select name="square_feet_options" id="id_square_feet_options" class="cmn-input">
              {% for option in form.fields.square_feet_options.queryset %}
                  <option value="{{ option.id }}" data-price="{{ option.price }}">{{ option.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="id_home_types">Home Type</label>
        <select name="home_types" id="id_home_types" class="cmn-input">
          {% for option in form.fields.home_types.queryset %}
            <option value="{{ option.id }}"
                    data-price="{{ option.price }}"
                    data-time="{{ option.extra_minutes }}">
              {{ option.name }} (${{ option.price }})
            </option>
          {% endfor %}
        </select>
      </div>

      
      <div id="cleaningExtrasContainer" class="mb-4">
        <h4 class="mt-4">Select Optional Extras</h4>
        <div class="row">
          {% for extra in cleaning_extras %}
            <div class="col-12 col-md-6 mb-2">
              <div class="form-check p-3 border rounded shadow-sm h-100">
                <input 
                  class="form-check-input extra-checkbox" 
                  type="checkbox" 
                  id="extra{{ extra.id }}" 
                  name="extras" 
                  value="{{ extra.id }}" 
                  data-price="{{ extra.price }}" 
                  data-time="{{ extra.extra_minutes }}"
                />
                <label class="form-check-label ms-2" for="extra{{ extra.id }}">
                  {{ extra.name }} <small class="text-muted">(+${{ extra.price }})</small>
                </label>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
      
      <!-- <button type="button" class="btn-1 btn-next" data-next="step2">Next ‚Üí</button> -->
    </div>


    <!-- Only visible when sqft is NOT 'Under 1000' -->
    <div id="largeHomeOptions" class="mb-4" style="display: none;">
      <h4>Large Home Cleaning Details</h4>
      <div class="row">
        <div class="col-12">
          <select name="cleaning_type" class="cmn-input">
            <option value="">Select Cleaning Type</option>
            <option value="1000-1500 (Regular)" selected>1000‚Äì1500 sq.ft (Regular Cleaning)</option>
            <option value="1000-1500 (Deep)">1000‚Äì1500 sq.ft (Deep Cleaning)</option>
            <option value="1000-1500 (Move)">1000‚Äì1500 sq.ft (Move In/Out Cleaning)</option>
            <option value="1000-1500 (Post)">1000‚Äì1500 sq.ft (Post Renovation)</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <select name="num_cleaners" class="cmn-input">
            <option value="1">1 Cleaner</option>
            <option value="2" selected>2 Cleaners</option>
            <option value="3">3 Cleaners</option>
          </select>
        </div>
        <div class="col-6">
          <select name="est_hours" class="cmn-input">
            <option value=""># of Hours</option>
            <option value="2">2 Hours</option>
            <option value="3" selected>3 Hours</option>
            <option value="4">4 Hours</option>
            <option value="5">5 Hours</option>
            <option value="6">6 Hours</option>
            <option value="7">7 Hours</option>
            <option value="8">8 Hours</option>
          </select>
        </div>
      </div>
    </div>
    

    

    <!-- Step 3: Contact Info -->
    <div class="step hidden-step" id="step3">
      <h4>Contact Info</h4>
      <input type="text" name="name" class="cmn-input" placeholder="Name" required>
      <input type="email" name="email" class="cmn-input" placeholder="Email" required>
      <input type="text" name="phone" class="cmn-input" placeholder="Phone (optional)">

      

      {{ form.city.label_tag }}
      {{ form.city }}
      {{ form.state }}
      <div class="row">
        <div class="col-9">
            {{ form.address }}
        </div>
        <div class="col-3">
            {{ form.apartment }}
        </div>
      </div>
    {{ form.zip_code }}

    <h4 class="mt-4">Discount Code</h4>
    <div class="row">
      <div class="col-8">
        <input type="text" name="discount" class="cmn-input" placeholder="Discount Code">
      </div>
      <div class="col-4">
        <button type="submit" class="btn-1 w-100" style="padding:16px;">Apply</button>
      </div>
    </div>
      <!-- Step 2: Schedule Info -->
    <div class="step hidden-step" id="step2">
      <h4 class="mt-4">Schedule</h4>
      <div class="form-row">
        <input type="hidden" id="id_hours_requested" name="hours_requested">
        <!-- <div class="form-group">
          <label for="{{ form.hours_requested.id_for_label }}">Hours</label>
          {{ form.hours_requested }}
        </div> -->
        <div class="form-group">
          <label for="{{ form.date.id_for_label }}">Date</label>
          <div style="position: relative;">
            {{ form.date }}
            <i class="icon-calendar" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none;"></i>
          </div>
        </div>
        <div class="form-group">
          <label for="{{ form.hour.id_for_label }}">Start Time</label>
          {{ form.hour }}
        </div>
      </div>

      {{ form.recurrence_pattern.label_tag }}
      {{ form.recurrence_pattern }}
      <!-- <button type="button" class="btn-1 btn-back" data-prev="step1">‚Üê Back</button>
      <button type="button" class="btn-1 btn-next" data-next="step3">Next ‚Üí</button> -->
    </div>

      {{ form.job_description.label_tag }}
      {{ form.job_description }}

      <!-- Price Summary -->
      <!-- Summary Box -->
<div class="service-summary mt-4 p-3 border rounded shadow-sm" style="background: #fff;">
  <!-- Dynamic Items -->
  <div id="summary-items" class="mb-3"></div>

  <!-- Date -->
  <div class="d-flex align-items-center mb-1">
    <i class="fa-solid fa-calendar-days me-2 text-muted"></i>
    <span id="summary-date">‚Äì</span>
  </div>

  <!-- Duration -->
  <div class="d-flex align-items-center mb-1">
    <i class="fa-regular fa-clock me-2 text-muted"></i>
    <span id="summary-duration">‚Äì</span>
  </div>

  <!-- Recurrence -->
  <div class="d-flex align-items-center mb-3">
    <i class="fa-solid fa-rotate me-2 text-muted"></i>
    <span id="summary-recurrence">‚Äì</span>
  </div>

  <hr>

  <!-- Totals -->
  <div class="d-flex justify-content-between">
    <strong>SUB-TOTAL</strong>
    <strong>$<span id="subtotalPrice">0.00</span></strong>
  </div>
  <div class="d-flex justify-content-between">
    <span>SALES TAX</span>
    <span>$<span id="salesTax">0.00</span></span>
  </div>
  <div class="d-flex justify-content-between mt-2" style="font-size: 1.3rem;">
    <strong>TOTAL</strong>
    <strong style="color: orange;">$<span id="totalPrice">0.00</span></strong>
  </div>
</div>

      <!-- Terms -->
    <div class="checkbox-wrap" >
        <input type="checkbox" id="terms" required>
        <label for="terms">I agree with all the terms & conditions</label>
      </div>
      <!-- <button type="button" class="btn-1 btn-back" data-prev="step2">‚Üê Back</button> -->
      <button type="submit" class="btn-1 w-100">Book Service</button>
    </div>
  </form>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    flatpickr("#id_date", {
      dateFormat: "Y-m-d",
      minDate: new Date().fp_incr(2), // Today + 2 days,
      defaultDate: new Date().fp_incr(2), // Today + 2 days,
      disableMobile: true // fallback for mobile native pickers
    });

    const dateField = document.getElementById("id_date");
    const hoursField = document.getElementById("id_hours_requested");
    const hourSelect = document.getElementById("id_hour");

    function fetchAvailableHours() {
      const selectedDate = dateField.value;
      const hoursField = document.getElementById("id_hours_requested");
      const selectedHours = parseFloat(hoursField?.value || "2");

      if (!selectedDate) return;

      hourSelect.innerHTML = "<option>Loading...</option>";
      hourSelect.disabled = true;

      fetch(`/quotes/api/available-hours/?date=${selectedDate}&hours=${selectedHours}`)
        .then(response => response.json())
        .then(data => {
          hourSelect.innerHTML = "";
          hourSelect.disabled = false;

          if (data.available_hours.length === 0) {
            hourSelect.innerHTML = "<option value=''>No available time</option>";
          } else {
            data.available_hours.forEach(hour => {
              const option = document.createElement("option");
              option.value = hour;
              option.textContent = hour;
              hourSelect.appendChild(option);
            });
          }
        })
        .catch(() => {
          hourSelect.innerHTML = "<option value=''>Failed to load</option>";
          hourSelect.disabled = false;
        });
    }

    // Attach Flatpickr change event instead of blur
    dateField._flatpickr.config.onChange.push(fetchAvailableHours);
    hoursField.addEventListener("blur", fetchAvailableHours);
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const sqftSelect = document.getElementById("id_square_feet_options");
    const homeType = document.getElementById("id_home_types").closest(".form-group") || document.getElementById("id_home_types").parentElement;
    const extrasContainer = document.getElementById("cleaningExtrasContainer");
    const largeHomeOptions = document.getElementById("largeHomeOptions");
    const cleanerSelect = document.querySelector('select[name="num_cleaners"]');
    const hourSelect = document.querySelector('select[name="est_hours"]');
    const cleaningTypeSelect = document.querySelector('select[name="cleaning_type"]');

    function resetSummary() {
      // 1. Reset home type to "Studio"
      const homeTypeSelect = document.getElementById("id_home_types");
      if (homeTypeSelect) {
        for (let i = 0; i < homeTypeSelect.options.length; i++) {
          if (homeTypeSelect.options[i].textContent.toLowerCase().includes("studio")) {
            homeTypeSelect.selectedIndex = i;
            break;
          }
        }
      }
    
      // 2. Uncheck all extras
      document.querySelectorAll(".extra-checkbox").forEach(cb => {
        cb.checked = false;
      });
    
      // 3. Reset date and time
      const today = new Date();
    today.setDate(today.getDate() + 2); // ‚úÖ Add 2 days
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const formattedDateInput = `${yyyy}-${mm}-${dd}`;
      const formattedDateText = `${mm}/${dd}/${yyyy}`;
      const time = "09:00"; // 9:00 AM
    
      const dateInput = document.getElementById("id_date");
      if (dateInput) dateInput.value = formattedDateInput;
    
      const timeInput = document.getElementById("id_hour");
      if (timeInput) timeInput.value = time;
    
      // 4. Reset recurrence to "One Time"
      const recurrenceSelect = document.getElementById("id_recurrence_pattern");
      if (recurrenceSelect) {
        for (let i = 0; i < recurrenceSelect.options.length; i++) {
          if (recurrenceSelect.options[i].textContent.toLowerCase().includes("one time")) {
            recurrenceSelect.selectedIndex = i;
            break;
          }
        }
      }
    
      // 5. Reset duration to base from selected Studio (data-time)
      const selectedOption = homeTypeSelect?.selectedOptions[0];
      let baseMinutes = parseInt(selectedOption?.dataset.time || "180"); // fallback to 3 hrs
    
      const finalHours = Math.floor(baseMinutes / 60);
      const finalMinutes = baseMinutes % 60;
      const hourLabel = finalHours === 1 ? "Hour" : "Hours";
      const minuteLabel = finalMinutes === 1 ? "Minute" : "Minutes";
    
      // 6. Update summary UI
      const price = parseFloat(selectedOption?.dataset.price || "130");
      const taxRate = 0.08875;
      const tax = price * taxRate;
      const total = price + tax;
    
      document.getElementById("summary-items").innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-1 ps-4 text-muted">
          <div>‚Ä¢ Studio ($130.00)</div>
          <div>$${price.toFixed(2)}</div>
        </div>`;
    
      document.getElementById("summary-date").textContent = `${formattedDateText} @ 9:00 AM`;
      document.getElementById("summary-duration").textContent = `${finalHours} ${hourLabel} ${finalMinutes} ${minuteLabel}`;
      document.getElementById("summary-recurrence").textContent = "One Time";
    
      document.getElementById("subtotalPrice").innerText = price.toFixed(2);
      document.getElementById("salesTax").innerText = tax.toFixed(2);
      document.getElementById("totalPrice").innerText = total.toFixed(2);
    }
    
    
    

    function toggleHomeAndExtras() {
      const selectedOption = sqftSelect?.selectedOptions[0];
      if (!selectedOption) return;

      const selectedName = selectedOption.textContent.trim().toLowerCase();
      const isUnder1000 = selectedName.includes("under 1000");

      if (isUnder1000) {
        homeType.style.display = "";
        extrasContainer.style.display = "";
        largeHomeOptions.style.display = "none";
      } else {
        homeType.style.display = "none";
        extrasContainer.style.display = "none";
        largeHomeOptions.style.display = "";

        // üî• Uncheck all extras when switching from 'Under 1000'
        document.querySelectorAll(".extra-checkbox").forEach(cb => cb.checked = false);

        if (selectedName.includes("1500‚Äì2000") || selectedName.includes("1500-2000")) {
          cleaningTypeSelect.innerHTML = `
            <option value="">Select Cleaning Type</option>
            <option value="1500-2000 (Regular)" selected>1500‚Äì2000 sq.ft (Regular Cleaning)</option>
            <option value="1500-2000 (Deep)">1500‚Äì2000 sq.ft (Deep Cleaning)</option>
            <option value="1500-2000 (Move)">1500‚Äì2000 sq.ft (Move In/Out Cleaning)</option>
            <option value="1500-2000 (Post)">1500‚Äì2000 sq.ft (Post Renovation)</option>
          `;
          cleanerSelect.value = "2";
          hourSelect.value = "5";
        } else if (selectedName.includes("custom")) {
          cleaningTypeSelect.innerHTML = `
            <option value="custom_cleaning" selected>Hourly Service 55$ per hour/per cleaner</option>
          `;
          cleanerSelect.value = "2";
          hourSelect.value = "5";
        } else if (selectedName.includes("renovation")) {
          cleaningTypeSelect.innerHTML = `
            <option value="post_renovation" selected>Hourly Service 60$ per hour/per cleaner</option>
          `;
          cleanerSelect.value = "2";
          hourSelect.value = "5";
        } else {
          cleaningTypeSelect.innerHTML = `
            <option value="">Select Cleaning Type</option>
            <option value="1000-1500 (Regular)" selected>1000‚Äì1500 sq.ft (Regular Cleaning)</option>
            <option value="1000-1500 (Deep)">1000‚Äì1500 sq.ft (Deep Cleaning)</option>
            <option value="1000-1500 (Move)">1000‚Äì1500 sq.ft (Move In/Out Cleaning)</option>
            <option value="1000-1500 (Post)">1000‚Äì1500 sq.ft (Post Renovation)</option>
          `;
          cleanerSelect.value = "2";
          hourSelect.value = "3";
        }

        cleaningTypeSelect?.dispatchEvent(new Event("change"));
      }

      updatePrice();
    }

    cleaningTypeSelect?.addEventListener("change", function () {
      const value = this.value.toLowerCase();

      if (value.includes("regular")) {
        cleanerSelect.value = value.includes("1500-2000") ? "2" : "2";
        hourSelect.value = value.includes("1500-2000") ? "5" : "3";
      } else if (value.includes("deep")) {
        cleanerSelect.value = value.includes("1500-2000") ? "3" : "2";
        hourSelect.value = "5";
      } else if (value.includes("move")) {
        cleanerSelect.value = value.includes("1500-2000") ? "3" : "2";
        hourSelect.value = "5";
      } else if (value.includes("post")) {
        cleanerSelect.value = "3";
        hourSelect.value = value.includes("1500-2000") ? "8" : "6";
      }

      updatePrice();
    });

    function updatePrice() {
      let subtotal = 0;
      const sqftPrice = parseFloat(sqftSelect?.selectedOptions[0]?.dataset.price || 0);
      subtotal += sqftPrice;

      if (homeType?.offsetParent !== null) {
        const homePrice = parseFloat(document.getElementById("id_home_types")?.selectedOptions[0]?.dataset.price || 0);
        subtotal += homePrice;
      }

      if (extrasContainer?.offsetParent !== null) {
        document.querySelectorAll(".extra-checkbox:checked").forEach(cb => {
          subtotal += parseFloat(cb.dataset.price || 0);
        });
      }

      // Labor cost
      let laborCost = 0;
      if (largeHomeOptions?.offsetParent !== null) {
        const numCleaners = parseInt(cleanerSelect?.value || 0);
        const hours = parseInt(hourSelect?.value || 0);
        const cleaningType = cleaningTypeSelect?.value || "";

        let hourlyRate = 55;
        if (cleaningType.toLowerCase().includes("post") || cleaningType.toLowerCase().includes("renovation")) {
          hourlyRate = 60;
        }

        laborCost = numCleaners * hours * hourlyRate;
        subtotal += laborCost;
      }

      const taxRate = 0.08875;
      const tax = subtotal * taxRate;
      const total = subtotal + tax;

      // Update UI
      document.getElementById("subtotalPrice").innerText = subtotal.toFixed(2);
      document.getElementById("salesTax").innerText = tax.toFixed(2);
      document.getElementById("totalPrice").innerText = total.toFixed(2);

      // Update summary list
      const summaryContainer = document.getElementById("summary-items");
      summaryContainer.innerHTML = "";

      if (sqftSelect) {
        const sqftLabel = sqftSelect.selectedOptions[0]?.textContent.trim();
        if (sqftPrice > 0) {
          summaryContainer.innerHTML += `
            <div class="d-flex justify-content-between align-items-center mb-1">
              <div><i class="fa-solid fa-house me-2"></i>${sqftLabel}</div>
              <div>$${sqftPrice.toFixed(2)}</div>
            </div>`;
        }
      }

      // 1.5 ‚Äì Home Type (only if visible and price > 0)
      if (homeType?.offsetParent !== null) {
        const homeTypeSelect = document.getElementById("id_home_types");
        const selectedOption = homeTypeSelect?.selectedOptions[0];
        const homeLabel = selectedOption?.textContent.trim();
        const homePrice = parseFloat(selectedOption?.dataset.price || 0).toFixed(2);

      if (homeLabel && homePrice > 0) {
          summaryContainer.innerHTML += `
            <div class="d-flex justify-content-between align-items-center mb-1 ps-4 text-muted">
              <div>‚Ä¢ ${homeLabel}</div>
            <div>$${homePrice}</div>
          </div>`;
        }
      }

      document.querySelectorAll(".extra-checkbox:checked").forEach(cb => {
        const label = cb.nextElementSibling?.textContent?.trim() || "Extra";
        const price = parseFloat(cb.dataset.price || 0).toFixed(2);
        summaryContainer.innerHTML += `
          <div class="d-flex justify-content-between align-items-center mb-1 ps-4 text-muted">
            <div>‚Ä¢ ${label}</div>
            <div>$${price}</div>
          </div>`;
      });

      if (largeHomeOptions?.offsetParent !== null && laborCost > 0) {
        summaryContainer.innerHTML += `
          <div class="d-flex justify-content-between align-items-center mb-1">
            <div><i class="fa-solid fa-broom me-2"></i>${cleanerSelect.value} Cleaners √ó ${hourSelect.value} Hours</div>
            <div>$${laborCost.toFixed(2)}</div>
          </div>`;
      }

      // Update schedule info
      const dateField = document.getElementById("id_date");
      const timeField = document.getElementById("id_hour");
      const recurrenceField = document.getElementById("id_recurrence_pattern");
      const hoursRequested = document.getElementById("id_hours_requested");

      document.getElementById("summary-date").textContent = `${dateField?.value || '-'} @ ${timeField?.value || '-'}`;
      document.getElementById("summary-recurrence").textContent = recurrenceField?.selectedOptions?.[0]?.textContent || "-";

      const estHoursSelect = document.querySelector('select[name="est_hours"]');
      const estHours = parseInt(estHoursSelect?.value || "0");

      // Count extra time from selected extras
      let totalMinutes = 0;

      // If large home is selected, use est_hours directly
      if (largeHomeOptions?.offsetParent !== null) {
        const hours = parseInt(hourSelect?.value || "0");
        totalMinutes = hours * 60;
      
      } else {
        // Otherwise, use home type base + extra minutes from extras
        const homeTypeSelect = document.getElementById("id_home_types");
        if (homeTypeSelect?.offsetParent !== null) {
          const selectedOption = homeTypeSelect.selectedOptions[0];
          const baseMinutes = parseInt(selectedOption?.dataset.time || "0");
          if (!isNaN(baseMinutes)) {
            totalMinutes = baseMinutes;
          }
        }
      
        document.querySelectorAll(".extra-checkbox:checked").forEach(cb => {
          const extraTime = parseInt(cb.dataset.time || "0");
          if (!isNaN(extraTime)) {
            totalMinutes += extraTime;
          }
        });
      }

// Convert to hours + minutes
const finalHours = Math.floor(totalMinutes / 60);
const finalMinutes = totalMinutes % 60;

const hoursRequestedInput = document.getElementById("id_hours_requested");
if (hoursRequestedInput) {
  const totalHoursDecimal = Math.round((totalMinutes / 60) * 2) / 2;
  hoursRequestedInput.value = totalHoursDecimal;
}

const hourLabel = finalHours === 1 ? "Hour" : "Hours";
const minuteLabel = finalMinutes === 1 ? "Minute" : "Minutes";

document.getElementById("summary-duration").textContent =
  `${finalHours} ${hourLabel} ${finalMinutes} ${minuteLabel}`;
        }

    // Force default sqft to "Under 1000"
    if (sqftSelect) {
      for (let i = 0; i < sqftSelect.options.length; i++) {
        if (sqftSelect.options[i].textContent.toLowerCase().includes("under 1000")) {
          sqftSelect.selectedIndex = i;
          break;
        }
      }
    }

    

    // Bind events
    sqftSelect?.addEventListener("change", toggleHomeAndExtras);
    document.querySelectorAll(".extra-checkbox").forEach(cb => cb.addEventListener("change", updatePrice));
    document.querySelectorAll("input, select").forEach(el => {
      el.addEventListener("change", updatePrice);
      el.addEventListener("input", () => {
        if (el.classList.contains("is-invalid") && el.value) {
          el.classList.remove("is-invalid");
        }
      });
    });

    cleanerSelect?.addEventListener("change", updatePrice);
    hourSelect?.addEventListener("change", updatePrice);

    // Initial setup
    toggleHomeAndExtras();
    updatePrice();
    resetSummary();
  });
</script>

    