<style>
  .summary-font {
    font-size: 20px !important;
  }

  .total-font {
    font-size: 24px !important;
  }

  /* Frequency Section Styles */
  .frequency-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .frequency-btn {
    padding: 12px 20px;
    border: 2px solid #ddd;
    background: white;
    color: #666;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
    min-width: 120px;
  }

  .frequency-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
  }

  .frequency-btn:hover {
    border-color: #007bff;
    color: #007bff;
  }

  .frequency-btn.active:hover {
    background: #0056b3;
    color: white;
  }

  /* Timezone Toggle Styles */
  .timezone-section {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .timezone-label {
    font-weight: 500;
    margin: 0;
  }

  .timezone-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .toggle-label {
    font-size: 14px;
    color: #666;
  }

  .toggle-switch {
    position: relative;
    width: 60px;
    height: 30px;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-switch label {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 30px;
  }

  .toggle-switch label:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }

  .toggle-switch input:checked + label {
    background-color: #dc3545;
  }

  .toggle-switch input:checked + label:before {
    transform: translateX(30px);
  }

  /* Calendar Navigation Styles */
  .calendar-navigation {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .nav-arrow {
    width: 40px;
    height: 40px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  .nav-arrow:hover {
    background: #f8f9fa;
    border-color: #007bff;
  }

  .calendar-dates {
    display: flex;
    gap: 15px;
    flex: 1;
    justify-content: center;
  }

  .date-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    min-width: 60px;
  }

  .date-item:hover {
    border-color: #007bff;
  }

  .date-item.selected {
    border-color: #007bff;
    background: #f8f9ff;
  }

  .date-icon {
    font-size: 16px;
    color: #666;
    margin-bottom: 5px;
  }

  .date-day {
    font-size: 12px;
    color: #999;
    font-weight: 500;
  }

  .date-number {
    font-size: 14px;
    font-weight: 600;
    color: #333;
  }

  /* Time Slots Styles */
  .time-slots {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 20px;
  }

  .time-slot {
    padding: 10px 15px;
    border: 2px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s;
    font-size: 14px;
    font-weight: 500;
  }

  .time-slot:hover {
    border-color: #007bff;
    color: #007bff;
  }

  .time-slot.selected {
    background: #007bff;
    color: white;
    border-color: #007bff;
  }

  .time-slot.unavailable {
    background: #f8f9fa;
    color: #999;
    cursor: not-allowed;
    border-color: #eee;
  }

  .time-slot.unavailable:hover {
    border-color: #eee;
    color: #999;
  }
</style>

<form method="post" id="quoteForm">
    {% csrf_token %}

    <input type="hidden" name="hours_requested" id="hidden_hours_requested">
    <input type="hidden" name="num_cleaners" id="hidden_num_cleaners">
    <input type="hidden" name="cleaning_type" id="hidden_cleaning_type">

    <!-- Tell Us About Your Cleaning Section -->
    <div class="step mb-4" id="step1">
      <h4 style="color: #666; margin-bottom: 30px;">Tell Us About Your Cleaning</h4>
      
      <!-- Type Of Business -->
      <div class="form-group mb-4">
        <label for="business_type" style="display: block; margin-bottom: 10px; font-weight: 500;">Type Of Business</label>
        <div class="business-type-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button type="button" class="business-type-btn active" data-value="office" style="padding: 10px 20px; border: 1px solid #ddd; background: #007bff; color: white; border-radius: 5px; cursor: pointer; transition: all 0.3s;">Office</button>
          <button type="button" class="business-type-btn" data-value="retail" style="padding: 10px 20px; border: 1px solid #ddd; background: white; color: #666; border-radius: 5px; cursor: pointer; transition: all 0.3s;">Retail</button>
          <button type="button" class="business-type-btn" data-value="medical" style="padding: 10px 20px; border: 1px solid #ddd; background: white; color: #666; border-radius: 5px; cursor: pointer; transition: all 0.3s;">Medical</button>
          <button type="button" class="business-type-btn" data-value="school" style="padding: 10px 20px; border: 1px solid #ddd; background: white; color: #666; border-radius: 5px; cursor: pointer; transition: all 0.3s;">School</button>
          <button type="button" class="business-type-btn" data-value="other" style="padding: 10px 20px; border: 1px solid #ddd; background: white; color: #666; border-radius: 5px; cursor: pointer; transition: all 0.3s;">Other</button>
        </div>
        <input type="hidden" name="business_type" id="business_type" value="office">
      </div>

      <!-- Crew/Size/Hours -->
      <div class="form-group mb-4">
        <label for="crew_size_hours" style="display: block; margin-bottom: 10px; font-weight: 500;">Crew/Size/Hours</label>
        <select name="crew_size_hours" id="crew_size_hours" class="cmn-input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
          <option value="1_cleaner_2_hours_500">1 Cleaner Total 2 Hours (&lt;500 Sq Ft)</option>
          <option value="2_cleaners_3_hours_1000">2 Cleaners Total 3 Hours (500-1000 Sq Ft)</option>
          <option value="2_cleaners_4_hours_1500">2 Cleaners Total 4 Hours (1000-1500 Sq Ft)</option>
          <option value="3_cleaners_5_hours_2000">3 Cleaners Total 5 Hours (1500-2000 Sq Ft)</option>
          <option value="3_cleaners_6_hours_2500">3 Cleaners Total 6 Hours (2000-2500 Sq Ft)</option>
          <option value="4_cleaners_8_hours_3000">4 Cleaners Total 8 Hours (2500-3000 Sq Ft)</option>
        </select>
      </div>

      <!-- How did you hear about us? -->
      <div class="form-group mb-4">
        <label for="hear_about_us" style="display: block; margin-bottom: 10px; font-weight: 500;">How did you hear about us?</label>
        <select name="hear_about_us" id="hear_about_us" class="cmn-input" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
          <option value="">Select an option</option>
          <option value="google">Google Search</option>
          <option value="social_media">Social Media</option>
          <option value="referral">Referral</option>
          <option value="advertisement">Advertisement</option>
          <option value="yelp">Yelp</option>
          <option value="other">Other</option>
        </select>
      </div>

      <!-- Hidden fields for compatibility -->
      <div style="display: none;">
        <div class="form-group">
          <label for="id_square_feet_options">Square Feet</label>
          <select name="square_feet_options" id="id_square_feet_options" class="cmn-input">
            {% for option in form.fields.square_feet_options.queryset %}
                <option value="{{ option.id }}" data-price="{{ option.price }}">{{ option.name }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="form-group">
          <label for="id_home_types">Home Type</label>
          <select name="home_types" id="id_home_types" class="cmn-input">
            {% for option in form.fields.home_types.queryset %}
              <option value="{{ option.id }}"
                      data-price="{{ option.price }}"
                      data-time="{{ option.extra_minutes }}">
                {{ option.name }} (${{ option.price }})
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
      
      <div id="cleaningExtrasContainer" class="mb-4" style="display: none;">
        <h4 class="mt-4">Select Optional Extras</h4>
        <div class="row">
          {% for extra in cleaning_extras %}
            <div class="col-12 col-md-6 mb-2">
              <div class="form-check p-3 border rounded shadow-sm h-100">
                <input 
                  class="form-check-input extra-checkbox" 
                  type="checkbox" 
                  id="extra{{ extra.id }}" 
                  name="extras" 
                  value="{{ extra.id }}" 
                  data-price="{{ extra.price }}" 
                  data-time="{{ extra.extra_minutes }}"
                />
                <label class="form-check-label ms-2" for="extra{{ extra.id }}">
                  {{ extra.name }} <small class="text-muted">(+${{ extra.price }})</small>
                </label>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>


    <!-- Only visible when sqft is NOT 'Under 1000' -->
    <div id="largeHomeOptions" class="mb-4" style="display: none;">
      <h4>Large Home Cleaning Details</h4>
      <div class="row">
        <div class="col-12">
          <select name="cleaning_type" class="cmn-input">
            <option value="">Select Cleaning Type</option>
            <option value="1000-1500 (Regular)" selected>1000–1500 sq.ft (Regular Cleaning)</option>
            <option value="1000-1500 (Deep)">1000–1500 sq.ft (Deep Cleaning)</option>
            <option value="1000-1500 (Move)">1000–1500 sq.ft (Move In/Out Cleaning)</option>
            <option value="1000-1500 (Post)">1000–1500 sq.ft (Post Renovation)</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-6">
          <select name="num_cleaners" class="cmn-input">
            <option value="1">1 Cleaner</option>
            <option value="2" selected>2 Cleaners</option>
            <option value="3">3 Cleaners</option>
          </select>
        </div>
        <div class="col-6">
          <select name="est_hours" class="cmn-input">
            <option value=""># of Hours</option>
            <option value="2">2 Hours</option>
            <option value="3" selected>3 Hours</option>
            <option value="4">4 Hours</option>
            <option value="5">5 Hours</option>
            <option value="6">6 Hours</option>
            <option value="7">7 Hours</option>
            <option value="8">8 Hours</option>
          </select>
        </div>
      </div>
    </div>
    

    

    <!-- Step 3: Contact Info -->
    <div class="step hidden-step" id="step3">
      <h4>Contact Info</h4>
      {{ form.name }}
      {{ form.email }}
      {{ form.phone }}
      {{ form.city }}
      {{ form.state }}
      <div class="row">
        <div class="col-9">
            {{ form.address }}
        </div>
        <div class="col-3">
            {{ form.apartment }}
        </div>
      </div>
    {{ form.zip_code }}

    <h4 class="mt-4">Discount Code</h4>
    <div class="row">
      <div class="col-8">
        <input type="text" name="discount" class="cmn-input" placeholder="Discount Code">
      </div>
      <div class="col-4">
        <button type="submit" class="btn-1 w-100" style="padding:16px;">Apply</button>
      </div>
    </div>
      <!-- Step 2: Schedule Info -->
    <div class="step" id="step2">
      <h4 class="mt-4 mb-3">Schedule</h4>
      
      <!-- Cleaning Frequency Section -->
      <div class="frequency-section mb-4">
        <h5>How often would you like us to clean?</h5>
        <p class="text-muted mb-3">Save With Our Cleany Loyalty Program! (Discount applied on 2nd cleaning and onward)</p>
        
        <div class="frequency-buttons">
          <button type="button" class="frequency-btn active" data-frequency="one_time" data-discount="0">
            One time
          </button>
          <button type="button" class="frequency-btn" data-frequency="daily" data-discount="20">
            Daily - 20% Off
          </button>
          <button type="button" class="frequency-btn" data-frequency="weekly" data-discount="15">
            Weekly 15% Off
          </button>
          <button type="button" class="frequency-btn" data-frequency="bi_weekly" data-discount="10">
            Bi Weekly 10% Off
          </button>
          <button type="button" class="frequency-btn" data-frequency="monthly" data-discount="5">
            Monthly 5% Off
          </button>
        </div>
        <input type="hidden" name="cleaning_frequency" id="cleaning_frequency" value="one_time">
        <input type="hidden" name="frequency_discount" id="frequency_discount" value="0">
      </div>

      <!-- Date of Service Section -->
      <div class="date-section mb-4">
        <h5>Date of service</h5>
        <p class="text-muted mb-3">For recurring services, each one will commence on the same day and time as selected for the first service.</p>
        
        <!-- Timezone Selection -->
        <div class="timezone-section mb-3">
          <label class="timezone-label">Choose a timezone</label>
          <div class="timezone-toggle">
            <span class="toggle-label">Our Company's</span>
            <div class="toggle-switch">
              <input type="checkbox" id="timezone_toggle" name="use_customer_timezone">
              <label for="timezone_toggle"></label>
            </div>
            <span class="toggle-label">Yours</span>
          </div>
        </div>
      </div>

      <!-- Calendar and Time Selection -->
      <div class="calendar-section">
        <div class="calendar-navigation mb-3">
          <button type="button" class="nav-arrow" id="prev_week">
            <i class="fa-solid fa-chevron-left"></i>
          </button>
          <div class="calendar-dates" id="calendar_dates">
            <!-- Calendar dates will be populated by JavaScript -->
          </div>
          <button type="button" class="nav-arrow" id="next_week">
            <i class="fa-solid fa-chevron-right"></i>
          </button>
        </div>
        
        <div class="time-slots" id="time_slots">
          <!-- Time slots will be populated by JavaScript -->
        </div>
      </div>

      <!-- Hidden form fields for compatibility -->
      <input type="hidden" name="selected_date" id="selected_date">
      <input type="hidden" name="selected_time" id="selected_time">
      <input type="hidden" name="recurrence_pattern" id="recurrence_pattern" value="one_time">
    </div>

      {{ form.job_description.label_tag }}
      {{ form.job_description }}

      <!-- Price Summary -->
      <!-- Summary Box -->
<div class="service-summary mt-4 p-3 border rounded shadow-sm" style="background: #fff;">
  <!-- Dynamic Items -->
  <div id="summary-items" class="mb-3"></div>

  <!-- Date -->
  <div class="d-flex align-items-center mb-1">
    <i class="fa-solid fa-calendar-days me-2 text-muted"></i>
    <span id="summary-date">–</span>
  </div>

  <!-- Duration -->
  <div class="d-flex align-items-center mb-1">
    <i class="fa-regular fa-clock me-2 text-muted"></i>
    <span id="summary-duration">–</span>
  </div>

  <!-- Recurrence -->
  <div class="d-flex align-items-center mb-3">
    <i class="fa-solid fa-rotate me-2 text-muted"></i>
    <span id="summary-recurrence">–</span>
  </div>

  <hr>

  <!-- Totals -->
  <div class="d-flex justify-content-between">
    <strong>SUB-TOTAL</strong>
    <strong>$<span id="subtotalPrice">0.00</span></strong>
  </div>
  <div class="d-flex justify-content-between">
    <span>SALES TAX</span>
    <span>$<span id="salesTax">0.00</span></span>
  </div>
  <div class="d-flex justify-content-between mt-2" style="font-size: 1.3rem;">
    <strong>TOTAL</strong>
    <strong style="color: orange;">$<span id="totalPrice">0.00</span></strong>
  </div>
</div>

      <!-- Terms -->
    <div class="checkbox-wrap" >
        <input type="checkbox" id="terms" required>
        <label for="terms">I agree with all the terms & conditions</label>
      </div>
      <!-- <button type="button" class="btn-1 btn-back" data-prev="step2">← Back</button> -->
      <button type="submit" class="btn-1 w-100">Book Service</button>
    </div>
  </form>

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
// ================================
// FLATPICKR + FORM LOGIC + PRICING ENGINE
// ================================
document.addEventListener("DOMContentLoaded", function () {
  // === Business Type Button Logic ===
  const businessTypeButtons = document.querySelectorAll('.business-type-btn');
  const businessTypeInput = document.getElementById('business_type');

  businessTypeButtons.forEach(button => {
    button.addEventListener('click', function() {
      // Remove active class from all buttons
      businessTypeButtons.forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#666';
      });
      
      // Add active class to clicked button
      this.style.background = '#007bff';
      this.style.color = 'white';
      
      // Update hidden input
      businessTypeInput.value = this.dataset.value;
    });
  });

  // === Frequency Button Logic ===
  const frequencyButtons = document.querySelectorAll('.frequency-btn');
  const frequencyInput = document.getElementById('cleaning_frequency');
  const discountInput = document.getElementById('frequency_discount');

  frequencyButtons.forEach(button => {
    button.addEventListener('click', function() {
      // Remove active class from all buttons
      frequencyButtons.forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Add active class to clicked button
      this.classList.add('active');
      
      // Update hidden inputs
      frequencyInput.value = this.dataset.frequency;
      discountInput.value = this.dataset.discount;
      
      // Update recurrence pattern
      document.getElementById('recurrence_pattern').value = this.dataset.frequency;
      
      // Update pricing
      updatePrice();
    });
  });

  // === Calendar and Time Selection Logic ===
  let currentWeekStart = new Date();
  currentWeekStart.setDate(currentWeekStart.getDate() + 2); // Start 2 days from now
  let selectedDate = null;
  let selectedTime = null;

  function renderCalendar() {
    const calendarDates = document.getElementById('calendar_dates');
    calendarDates.innerHTML = '';
    
    for (let i = 0; i < 7; i++) {
      const date = new Date(currentWeekStart);
      date.setDate(currentWeekStart.getDate() + i);
      
      const dayNames = ['Su', 'M', 'Tu', 'W', 'Th', 'F', 'Sa'];
      const dayName = dayNames[date.getDay()];
      const dateNumber = date.getDate();
      const month = date.getMonth() + 1;
      
      const dateItem = document.createElement('div');
      dateItem.className = 'date-item';
      dateItem.innerHTML = `
        <div class="date-icon">
          <i class="fa-solid fa-calendar"></i>
        </div>
        <div class="date-day">${dayName}</div>
        <div class="date-number">${month}/${dateNumber.toString().padStart(2, '0')}</div>
      `;
      
      dateItem.addEventListener('click', () => selectDate(date));
      calendarDates.appendChild(dateItem);
    }
    
    // Select first date by default
    if (!selectedDate) {
      selectDate(new Date(currentWeekStart));
    }
  }

  function selectDate(date) {
    selectedDate = date;
    
    // Update visual selection
    document.querySelectorAll('.date-item').forEach(item => {
      item.classList.remove('selected');
    });
    event.target.closest('.date-item').classList.add('selected');
    
    // Update hidden field
    document.getElementById('selected_date').value = date.toISOString().split('T')[0];
    
    // Load time slots for selected date
    loadTimeSlots(date);
  }

  function loadTimeSlots(date) {
    const timeSlots = document.getElementById('time_slots');
    timeSlots.innerHTML = '';
    
    // Generate time slots based on day of week
    const dayOfWeek = date.getDay();
    let startHour = 8;
    let endHour = 18;
    
    // Different hours for weekdays vs weekends
    if (dayOfWeek === 0 || dayOfWeek === 6) { // Sunday or Saturday
      startHour = 8;
      endHour = 18;
    } else { // Weekdays
      startHour = 11;
      endHour = 18;
    }
    
    for (let hour = startHour; hour <= endHour; hour++) {
      const timeSlot = document.createElement('div');
      timeSlot.className = 'time-slot';
      timeSlot.textContent = `${hour}:00${hour < 12 ? 'am' : hour === 12 ? 'pm' : 'pm'}`;
      
      timeSlot.addEventListener('click', () => selectTimeSlot(timeSlot, hour));
      timeSlots.appendChild(timeSlot);
    }
    
    // Select first time slot by default
    if (timeSlots.children.length > 0) {
      selectTimeSlot(timeSlots.children[0], startHour);
    }
  }

  function selectTimeSlot(slot, hour) {
    selectedTime = hour;
    
    // Update visual selection
    document.querySelectorAll('.time-slot').forEach(s => {
      s.classList.remove('selected');
    });
    slot.classList.add('selected');
    
    // Update hidden field
    document.getElementById('selected_time').value = `${hour}:00`;
    
    // Update summary
    updatePrice();
  }

  // Navigation arrows
  document.getElementById('prev_week').addEventListener('click', () => {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    renderCalendar();
  });

  document.getElementById('next_week').addEventListener('click', () => {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    renderCalendar();
  });

  // Initialize calendar
  renderCalendar();

  // === Flatpickr Setup ===
  flatpickr("#id_date", {
    dateFormat: "Y-m-d",
    minDate: new Date().fp_incr(2),
    defaultDate: new Date().fp_incr(2),
    disableMobile: true
  });

  // === Shared DOM Elements ===
  const dateField = document.getElementById("id_date");
  const hourSelect = document.getElementById("id_hour");
  const hoursField = document.querySelector('select[name="est_hours"]');
  const sqftSelect = document.getElementById("id_square_feet_options");
  const cleanerSelect = document.querySelector('select[name="num_cleaners"]');
  const cleaningTypeSelect = document.querySelector('select[name="cleaning_type"]');
  const homeTypeGroup = document.getElementById("id_home_types")?.closest(".form-group");
  const extrasContainer = document.getElementById("cleaningExtrasContainer");
  const largeHomeOptions = document.getElementById("largeHomeOptions");
  const crewSizeHoursSelect = document.getElementById("crew_size_hours");

  function isSmallHomeSelected() {
    const selectedOption = sqftSelect?.selectedOptions[0];
    if (!selectedOption) return false;
    return selectedOption.textContent.toLowerCase().includes("under 1000");
  }

  // === Load available hours dynamically ===
  function fetchAvailableHours() {
    const selectedDate = dateField?.value;
    let selectedHours = 3; // default fallback

    if (largeHomeOptions?.offsetParent !== null) {
      // Use selected value for large homes
      selectedHours = parseInt(hoursField?.value || "3");
    } else {
      // Use home type + extras for small homes
      const homeSelect = document.getElementById("id_home_types");
      let totalMinutes = parseInt(homeSelect?.selectedOptions[0]?.dataset.time || "0");

  document.querySelectorAll(".extra-checkbox:checked").forEach(cb => {
    totalMinutes += parseInt(cb.dataset.time || "0") || 0;
  });

  selectedHours = Math.ceil(totalMinutes / 60); // round up to next full hour
}

    if (!selectedDate || isNaN(selectedHours)) return;

    hourSelect.innerHTML = "<option>Loading...</option>";
    hourSelect.disabled = true;

    fetch(`/quotes/api/available-hours/?date=${selectedDate}&hours=${selectedHours}`)
      .then(response => response.json())
      .then(data => {
        hourSelect.innerHTML = "";
        hourSelect.disabled = false;

        if (!data.available_hours || data.available_hours.length === 0) {
          hourSelect.innerHTML = "<option value=''>No available time</option>";
        } else {
          data.available_hours.forEach((hour, index) => {
            const option = document.createElement("option");
            option.value = hour;
            option.textContent = hour;
            if (index === 0) option.selected = true;
            hourSelect.appendChild(option);
          });

          if (data.available_hours.length === 1) {
            hourSelect.value = data.available_hours[0];
          }
        }

        updatePrice();
      })
      .catch((err) => {
        console.error("❌ Failed to fetch available hours:", err);
        hourSelect.innerHTML = "<option value=''>Failed to load</option>";
        hourSelect.disabled = false;
      });
  }

  // === UI Defaults ===
  function setDefaultSquareFeet() {
    for (let i = 0; i < sqftSelect.options.length; i++) {
      if (sqftSelect.options[i].textContent.toLowerCase().includes("under 1000")) {
        sqftSelect.selectedIndex = i;
        break;
      }
    }
  }

  function toggleHomeAndExtras() {
    const selectedOption = sqftSelect?.selectedOptions[0];
    if (!selectedOption) return;

    const selectedName = selectedOption.textContent.trim().toLowerCase();
    const isUnder1000 = selectedName.includes("under 1000");

    if (isUnder1000) {
      homeTypeGroup.style.display = "";
      extrasContainer.style.display = "";
      largeHomeOptions.style.display = "none";
    } else {
      homeTypeGroup.style.display = "none";
      extrasContainer.style.display = "none";
      largeHomeOptions.style.display = "";

      document.querySelectorAll(".extra-checkbox").forEach(cb => cb.checked = false);

      if (selectedName.includes("1500–2000") || selectedName.includes("1500-2000")) {
        cleaningTypeSelect.innerHTML = `
          <option value="">Select Cleaning Type</option>
          <option value="1500-2000 (Regular)" selected>1500–2000 sq.ft (Regular Cleaning)</option>
          <option value="1500-2000 (Deep)">1500–2000 sq.ft (Deep Cleaning)</option>
          <option value="1500-2000 (Move)">1500–2000 sq.ft (Move In/Out Cleaning)</option>
          <option value="1500-2000 (Post)">1500–2000 sq.ft (Post Renovation)</option>
        `;
        cleanerSelect.value = "2";
        hoursField.value = "5";
      } else if (selectedName.includes("custom")) {
        cleaningTypeSelect.innerHTML = `
          <option value="custom_cleaning" selected>Hourly Service 55$ per hour/per cleaner</option>
        `;
        cleanerSelect.value = "2";
        hoursField.value = "5";
      } else if (selectedName.includes("renovation")) {
        cleaningTypeSelect.innerHTML = `
          <option value="post_renovation" selected>Hourly Service 60$ per hour/per cleaner</option>
        `;
        cleanerSelect.value = "2";
        hoursField.value = "5";
      } else {
        cleaningTypeSelect.innerHTML = `
          <option value="">Select Cleaning Type</option>
          <option value="1000-1500 (Regular)" selected>1000–1500 sq.ft (Regular Cleaning)</option>
          <option value="1000-1500 (Deep)">1000–1500 sq.ft (Deep Cleaning)</option>
          <option value="1000-1500 (Move)">1000–1500 sq.ft (Move In/Out Cleaning)</option>
          <option value="1000-1500 (Post)">1000–1500 sq.ft (Post Renovation)</option>
        `;
        cleanerSelect.value = "2";
        hoursField.value = "3";
      }

      cleaningTypeSelect?.dispatchEvent(new Event("change"));
    }

    updatePrice();
  }

  cleaningTypeSelect?.addEventListener("change", function () {
    const value = this.value.toLowerCase();

    if (value.includes("regular")) {
      cleanerSelect.value = value.includes("1500-2000") ? "2" : "2";
      hoursField.value = value.includes("1500-2000") ? "5" : "3";
    } else if (value.includes("deep")) {
      cleanerSelect.value = value.includes("1500-2000") ? "3" : "2";
      hoursField.value = "5";
    } else if (value.includes("move")) {
      cleanerSelect.value = value.includes("1500-2000") ? "3" : "2";
      hoursField.value = "5";
    } else if (value.includes("post")) {
      cleanerSelect.value = "3";
      hoursField.value = value.includes("1500-2000") ? "8" : "6";
    }

    updatePrice();
  });

  // Run initializers
  setDefaultSquareFeet();
  toggleHomeAndExtras();
  fetchAvailableHours();
  updatePrice();
  resetSummary();

  // === Event Bindings ===
  crewSizeHoursSelect?.addEventListener("change", updatePrice);
  crewSizeHoursSelect?.addEventListener("change", fetchAvailableHours);
  
  // Legacy event bindings (for compatibility)
  sqftSelect?.addEventListener("change", toggleHomeAndExtras);
  sqftSelect?.addEventListener("change", fetchAvailableHours);
  cleaningTypeSelect?.addEventListener("change", fetchAvailableHours);
  cleanerSelect?.addEventListener("change", fetchAvailableHours);
  hoursField?.addEventListener("change", fetchAvailableHours);

  // Refresh on blur (when user clicks out of the input)
  dateField.addEventListener("change", fetchAvailableHours);
  hoursField.addEventListener("change", fetchAvailableHours);

  document.querySelectorAll(".extra-checkbox").forEach(cb => cb.addEventListener("change", updatePrice));
  document.querySelectorAll("input, select").forEach(el => {
    el.addEventListener("change", updatePrice);
    el.addEventListener("input", () => {
      if (el.classList.contains("is-invalid") && el.value) {
        el.classList.remove("is-invalid");
      }
    });
  });
  cleanerSelect?.addEventListener("change", updatePrice);
  hoursField?.addEventListener("change", updatePrice);
  cleaningTypeSelect?.addEventListener("change", updatePrice);

   // ================================
  // PRICE & SUMMARY CALCULATOR
  // ================================
  function updatePrice() {
    let subtotal = 0;
    
    // Calculate price based on crew/size/hours selection
    const crewSelection = crewSizeHoursSelect?.value || "";
    let numCleaners = 1;
    let hours = 2;
    let sqft = 500;
    
    if (crewSelection) {
      const parts = crewSelection.split('_');
      numCleaners = parseInt(parts[0]) || 1;
      hours = parseInt(parts[2]) || 2;
      sqft = parseInt(parts[3]) || 500;
    }
    
    // Base pricing logic for office cleaning
    const hourlyRate = 55; // $55 per hour per cleaner
    const laborCost = numCleaners * hours * hourlyRate;
    subtotal = laborCost;

    // Add any extras if they exist
    if (extrasContainer?.offsetParent !== null) {
      document.querySelectorAll(".extra-checkbox:checked").forEach(cb => {
        subtotal += parseFloat(cb.dataset.price || 0);
      });
    }

    // Apply frequency discount
    const frequencyDiscount = parseFloat(document.getElementById('frequency_discount')?.value || 0);
    const discountAmount = subtotal * (frequencyDiscount / 100);
    const discountedSubtotal = subtotal - discountAmount;
    
    const taxRate = 0.08875;
    const tax = discountedSubtotal * taxRate;
    const total = discountedSubtotal + tax;

    // Update UI values
    document.getElementById("subtotalPrice").innerText = discountedSubtotal.toFixed(2);
    document.getElementById("salesTax").innerText = tax.toFixed(2);
    document.getElementById("totalPrice").innerText = total.toFixed(2);
    
    // Show discount if applicable
    if (frequencyDiscount > 0) {
      summaryContainer.innerHTML += `
        <div class="d-flex justify-content-between align-items-center mb-1 text-success">
          <div><i class="fa-solid fa-tag me-2"></i>Frequency Discount (${frequencyDiscount}%)</div>
          <div>-$${discountAmount.toFixed(2)}</div>
        </div>`;
    }

    // Update summary items list
    const summaryContainer = document.getElementById("summary-items");
    summaryContainer.innerHTML = "";

    // Show the selected crew/size/hours option
    if (crewSelection) {
      const crewLabel = crewSizeHoursSelect?.selectedOptions[0]?.textContent.trim() || "Office Cleaning";
      summaryContainer.innerHTML += `
        <div class="d-flex justify-content-between align-items-center mb-1">
          <div><i class="fa-solid fa-building me-2"></i>${crewLabel}</div>
          <div>$${laborCost.toFixed(2)}</div>
        </div>`;
    }

    // Show any extras
    document.querySelectorAll(".extra-checkbox:checked").forEach(cb => {
      const label = cb.nextElementSibling?.textContent?.trim() || "Extra";
      const price = parseFloat(cb.dataset.price || 0).toFixed(2);
      summaryContainer.innerHTML += `
        <div class="d-flex justify-content-between align-items-center mb-1 ps-4 text-muted">
          <div>• ${label}</div>
          <div>$${price}</div>
        </div>`;
    });

    // Update schedule info
    const dateVal = document.getElementById("selected_date")?.value || "-";
    const timeVal = document.getElementById("selected_time")?.value || "-";
    const frequencyVal = document.getElementById("cleaning_frequency")?.value || "one_time";
    
    // Format date for display
    let formattedDate = "-";
    if (dateVal !== "-") {
      const date = new Date(dateVal);
      formattedDate = `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()}`;
    }
    
    // Format time for display
    let formattedTime = "-";
    if (timeVal !== "-") {
      const hour = parseInt(timeVal.split(':')[0]);
      const ampm = hour < 12 ? 'am' : 'pm';
      const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
      formattedTime = `${displayHour}:00 ${ampm}`;
    }

    document.getElementById("summary-date").textContent = `${formattedDate} @ ${formattedTime}`;
    
    // Format frequency for display
    const frequencyLabels = {
      'one_time': 'One Time',
      'daily': 'Daily',
      'weekly': 'Weekly',
      'bi_weekly': 'Bi-Weekly',
      'monthly': 'Monthly'
    };
    document.getElementById("summary-recurrence").textContent = frequencyLabels[frequencyVal] || "One Time";

    // Calculate and display total duration
    let totalMinutes = hours * 60; // Convert hours to minutes
    

    const finalHours = Math.floor(totalMinutes / 60);
    const finalMinutes = totalMinutes % 60;
    const hourLabel = finalHours === 1 ? "Hour" : "Hours";
    const minuteLabel = finalMinutes === 1 ? "Minute" : "Minutes";
    document.getElementById("summary-duration").textContent = `${finalHours} ${hourLabel} ${finalMinutes} ${minuteLabel}`;
  }

  function resetSummary() {
    // 1. Reset home type to "Studio"
    const homeTypeSelect = document.getElementById("id_home_types");
    if (homeTypeSelect) {
      for (let i = 0; i < homeTypeSelect.options.length; i++) {
        if (homeTypeSelect.options[i].textContent.toLowerCase().includes("studio")) {
          homeTypeSelect.selectedIndex = i;
          break;
        }
      }
    }
  
    // 2. Uncheck all extras
    document.querySelectorAll(".extra-checkbox").forEach(cb => {
      cb.checked = false;
    });
  
    // 3. Reset date and time
    const today = new Date();
    today.setDate(today.getDate() + 2); // ✅ Add 2 days
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const formattedDateInput = `${yyyy}-${mm}-${dd}`;
    const formattedDateText = `${mm}/${dd}/${yyyy}`;
    const time = "09:00"; // 9:00 AM
  
    const dateInput = document.getElementById("id_date");
    if (dateInput) dateInput.value = formattedDateInput;
  
    const timeInput = document.getElementById("id_hour");
    if (timeInput) timeInput.value = time;
  
    // 4. Reset recurrence to "One Time"
    const recurrenceSelect = document.getElementById("id_recurrence_pattern");
    if (recurrenceSelect) {
      for (let i = 0; i < recurrenceSelect.options.length; i++) {
        if (recurrenceSelect.options[i].textContent.toLowerCase().includes("one time")) {
          recurrenceSelect.selectedIndex = i;
          break;
        }
      }
    }
  
    // 5. Reset duration to base from selected Studio (data-time)
    const selectedOption = homeTypeSelect?.selectedOptions[0];
    let baseMinutes = parseInt(selectedOption?.dataset.time || "180"); // fallback to 3 hrs
  
    const finalHours = Math.floor(baseMinutes / 60);
    const finalMinutes = baseMinutes % 60;
    const hourLabel = finalHours === 1 ? "Hour" : "Hours";
    const minuteLabel = finalMinutes === 1 ? "Minute" : "Minutes";
  
    // 6. Update summary UI
    const price = parseFloat(selectedOption?.dataset.price || "130");
    const taxRate = 0.08875;
    const tax = price * taxRate;
    const total = price + tax;
  
    document.getElementById("summary-items").innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-1 ps-4 text-muted">
        <div>• Studio ($130.00)</div>
        <div>$${price.toFixed(2)}</div>
      </div>`;
  
    document.getElementById("summary-date").textContent = `${formattedDateText} @ 9:00 AM`;
    document.getElementById("summary-duration").textContent = `${finalHours} ${hourLabel} ${finalMinutes} ${minuteLabel}`;
    document.getElementById("summary-recurrence").textContent = "One Time";
  
    document.getElementById("subtotalPrice").innerText = price.toFixed(2);
    document.getElementById("salesTax").innerText = tax.toFixed(2);
    document.getElementById("totalPrice").innerText = total.toFixed(2);
  }

  function syncHiddenFields() {
    // Extract data from crew/size/hours selection
    const crewSelection = crewSizeHoursSelect?.value || "";
    let numCleaners = 1;
    let hours = 2;
    
    if (crewSelection) {
      const parts = crewSelection.split('_');
      numCleaners = parseInt(parts[0]) || 1;
      hours = parseInt(parts[2]) || 2;
    }
    
    document.getElementById("hidden_hours_requested").value = hours;
    document.getElementById("hidden_num_cleaners").value = numCleaners;
    document.getElementById("hidden_cleaning_type").value = "office_cleaning";
  }
  document.getElementById("quoteForm").addEventListener("submit", function () {
    syncHiddenFields(); // ✅ ensures all values are ready
  });
});
</script>


    