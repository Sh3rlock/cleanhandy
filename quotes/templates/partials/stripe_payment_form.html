<!-- Stripe Payment Form Component -->
{% load static %}
<div id="stripe-payment-section" class="mt-4" style="display: none;">
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fa-solid fa-credit-card me-2"></i>Secure Payment</h5>
    </div>
    <div class="card-body">
      <!-- Payment Method Selection -->
      <div class="mb-3">
        <h6>Choose Payment Option:</h6>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="payment_option" id="payment_deposit" value="deposit" checked>
          <label class="form-check-label" for="payment_deposit">
            <strong>Pay 50% Deposit Now</strong> <span class="text-muted">($<span id="deposit-amount">0.00</span>)</span>
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="payment_option" id="payment_full" value="full">
          <label class="form-check-label" for="payment_full">
            <strong>Pay Full Amount Now</strong> <span class="text-muted">($<span id="full-amount">0.00</span>)</span>
          </label>
        </div>
      </div>

      <!-- Payment Status Display -->
      <div id="payment-status-display" class="alert alert-info" style="display: none;">
        <i class="fa-solid fa-info-circle me-2"></i>
        <span id="payment-status-text"></span>
      </div>

      <!-- Stripe Elements Container -->
      <div id="stripe-payment-form" style="display: none;">
        <div class="mb-3">
          <label for="card-element" class="form-label">Card Information</label>
          <div id="card-element" class="form-control p-3" style="min-height: 50px;">
            <!-- Stripe Elements will create form elements here -->
          </div>
          <div id="card-errors" role="alert" class="invalid-feedback"></div>
        </div>

        <div class="mb-3">
          <label for="billing-email" class="form-label">Billing Email</label>
          <input type="email" id="billing-email" class="form-control" placeholder="Enter your email address" required>
        </div>

        <div class="mb-3">
          <label for="billing-name" class="form-label">Cardholder Name</label>
          <input type="text" id="billing-name" class="form-control" placeholder="Enter cardholder name" required>
        </div>

        <button id="submit-payment" class="btn btn-primary w-100" disabled>
          <span id="payment-button-text">Pay <span id="payment-amount">$0.00</span></span>
          <span id="payment-spinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
        </button>
      </div>

      <!-- Payment Success Message -->
      <div id="payment-success" class="alert alert-success" style="display: none;">
        <i class="fa-solid fa-check-circle me-2"></i>
        <strong>Payment Successful!</strong>
        <p class="mb-0 mt-2">Your booking has been confirmed. You will receive a confirmation email shortly.</p>
      </div>

      <!-- Payment Error Message -->
      <div id="payment-error" class="alert alert-danger" style="display: none;">
        <i class="fa-solid fa-exclamation-triangle me-2"></i>
        <strong>Payment Failed</strong>
        <p class="mb-0 mt-2" id="payment-error-text"></p>
      </div>
    </div>
  </div>
</div>

<style>
  /* Stripe Elements Styling */
  .StripeElement {
    background-color: white;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid transparent;
    box-shadow: 0 1px 3px 0 #e6ebf1;
    transition: box-shadow 150ms ease;
  }

  .StripeElement--focus {
    box-shadow: 0 1px 3px 0 #cfd7df;
  }

  .StripeElement--invalid {
    border-color: #fa755a;
  }

  .StripeElement--webkit-autofill {
    background-color: #fefde5 !important;
  }

  #card-element {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    padding: 0.75rem;
    background-color: #fff;
  }

  #card-element:focus {
    border-color: #F15A29;
    box-shadow: 0 0 0 0.2rem rgba(241, 90, 41, 0.25);
  }

  .payment-option-info {
    font-size: 0.9rem;
    color: #6c757d;
    margin-top: 0.5rem;
  }

  .payment-amount {
    font-weight: 600;
    color: #F15A29;
  }
</style>

<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Initialize Stripe
  const stripe = Stripe('{{ STRIPE_PUBLISHABLE_KEY }}');
  let elements;
  let cardElement;
  let clientSecret;
  let currentBookingId = null;
  let currentPaymentType = 'deposit';

  // Payment form elements
  const paymentSection = document.getElementById('stripe-payment-section');
  const paymentForm = document.getElementById('stripe-payment-form');
  const paymentStatusDisplay = document.getElementById('payment-status-display');
  const paymentStatusText = document.getElementById('payment-status-text');
  const paymentSuccess = document.getElementById('payment-success');
  const paymentError = document.getElementById('payment-error');
  const paymentErrorText = document.getElementById('payment-error-text');
  const submitButton = document.getElementById('submit-payment');
  const paymentButtonText = document.getElementById('payment-button-text');
  const paymentAmount = document.getElementById('payment-amount');
  const paymentSpinner = document.getElementById('payment-spinner');

  // Deposit and full amount displays
  const depositAmountDisplay = document.getElementById('deposit-amount');
  const fullAmountDisplay = document.getElementById('full-amount');

  // Payment option radio buttons
  const depositOption = document.getElementById('payment_deposit');
  const fullOption = document.getElementById('payment_full');

  // Initialize payment form when booking is ready
  window.initializeStripePayment = function(bookingId, totalAmount) {
    currentBookingId = bookingId;
    const depositAmount = (totalAmount / 2).toFixed(2);
    
    // Update amount displays
    depositAmountDisplay.textContent = depositAmount;
    fullAmountDisplay.textContent = totalAmount.toFixed(2);
    paymentAmount.textContent = `$${depositAmount}`;

    // Show payment section
    paymentSection.style.display = 'block';
    updatePaymentStatus('Ready to process payment');

    // Set up payment option change handlers
    depositOption.addEventListener('change', handlePaymentOptionChange);
    fullOption.addEventListener('change', handlePaymentOptionChange);

    // Set up form submission
    setupPaymentForm();
  };

  function handlePaymentOptionChange() {
    if (depositOption.checked) {
      currentPaymentType = 'deposit';
      const amount = parseFloat(depositAmountDisplay.textContent);
      paymentAmount.textContent = `$${amount.toFixed(2)}`;
    } else {
      currentPaymentType = 'full';
      const amount = parseFloat(fullAmountDisplay.textContent);
      paymentAmount.textContent = `$${amount.toFixed(2)}`;
    }
    
    // Reinitialize payment intent for new amount
    if (currentBookingId) {
      createPaymentIntent();
    }
  }

  function setupPaymentForm() {
    // Create card element
    elements = stripe.elements();
    cardElement = elements.create('card', {
      style: {
        base: {
          fontSize: '16px',
          color: '#424770',
          '::placeholder': {
            color: '#aab7c4',
          },
        },
      },
    });

    cardElement.mount('#card-element');

    // Handle real-time validation errors from the card Element
    cardElement.on('change', function(event) {
      const displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
        displayError.style.display = 'block';
      } else {
        displayError.textContent = '';
        displayError.style.display = 'none';
      }
      
      // Enable/disable submit button
      submitButton.disabled = !event.complete;
    });

    // Handle form submission
    submitButton.addEventListener('click', handlePaymentSubmission);

    // Create initial payment intent
    createPaymentIntent();
  }

  function createPaymentIntent() {
    if (!currentBookingId) return;

    updatePaymentStatus('Creating payment...', 'info');

    fetch('/quotes/api/create-payment-intent/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify({
        booking_id: currentBookingId,
        payment_type: currentPaymentType,
        frontend_total_amount: parseFloat(document.getElementById("totalPrice").textContent),
      }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      
      clientSecret = data.client_secret;
      updatePaymentStatus('Ready to process payment');
      showPaymentForm();
    })
    .catch(error => {
      console.error('Error creating payment intent:', error);
      updatePaymentStatus(`Error: ${error.message}`, 'danger');
    });
  }

  function handlePaymentSubmission(event) {
    event.preventDefault();

    if (!clientSecret) {
      updatePaymentStatus('Payment not ready. Please try again.', 'danger');
      return;
    }

    // Get billing information
    const billingEmail = document.getElementById('billing-email').value;
    const billingName = document.getElementById('billing-name').value;

    if (!billingEmail || !billingName) {
      updatePaymentStatus('Please fill in all required fields.', 'danger');
      return;
    }

    // Show loading state
    setPaymentLoading(true);
    updatePaymentStatus('Processing payment...', 'info');

    stripe.confirmCardPayment(clientSecret, {
      payment_method: {
        card: cardElement,
        billing_details: {
          name: billingName,
          email: billingEmail,
        },
      },
    })
    .then(function(result) {
      if (result.error) {
        // Show error to customer
        setPaymentLoading(false);
        updatePaymentStatus(`Payment failed: ${result.error.message}`, 'danger');
      } else {
        // Payment succeeded
        handlePaymentSuccess(result.paymentIntent);
      }
    });
  }

  function handlePaymentSuccess(paymentIntent) {
    console.log('Payment succeeded:', paymentIntent);
    
    // Hide form and show success message
    paymentForm.style.display = 'none';
    paymentSuccess.style.display = 'block';
    updatePaymentStatus('Payment completed successfully!', 'success');
    
    // Disable form submission and show success
    submitButton.disabled = true;
    
    // Update booking status if needed
    if (typeof updateBookingStatus === 'function') {
      updateBookingStatus('payment_completed');
    }
  }

  function setPaymentLoading(loading) {
    if (loading) {
      submitButton.disabled = true;
      paymentSpinner.style.display = 'inline-block';
      paymentButtonText.style.opacity = '0.7';
    } else {
      submitButton.disabled = false;
      paymentSpinner.style.display = 'none';
      paymentButtonText.style.opacity = '1';
    }
  }

  function showPaymentForm() {
    paymentForm.style.display = 'block';
    paymentError.style.display = 'none';
    paymentSuccess.style.display = 'none';
  }

  function updatePaymentStatus(message, type = 'info') {
    paymentStatusText.textContent = message;
    paymentStatusDisplay.className = `alert alert-${type}`;
    paymentStatusDisplay.style.display = 'block';
  }

  // Export functions for use by parent form
  window.processStripePayment = function(bookingId, totalAmount) {
    initializeStripePayment(bookingId, totalAmount);
  };
});
</script>
