{% extends "accounts/partials/account_base.html" %}
{% load static %}
{% block account_content %}

<style>
     section {
        z-index: unset !important;
     }

     .text-primary {
        color: #F15A29 !important;
      }

      .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-pending {
        background-color: #fef3c7;
        color: #92400e;
      }

      .status-reviewed {
        background-color: #dbeafe;
        color: #1e40af;
      }

      .status-quoted {
        background-color: #d1fae5;
        color: #065f46;
      }

      .status-accepted {
        background-color: #dcfce7;
        color: #166534;
      }

      .status-declined {
        background-color: #fee2e2;
        color: #991b1b;
      }

      .quote-card {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      }

      .quote-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #F15A29;
        padding: 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
      }

      .quote-body {
        padding: 1.5rem;
      }

      .form-group label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
      }

      .form-control {
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
      }

      .form-control:focus {
        border-color: #F15A29;
        box-shadow: 0 0 0 3px rgba(241, 90, 41, 0.1);
      }

      .custom-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
      }

      .custom-modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 1rem;
        border-radius: 8px;
        width: 100%;
        max-width: 600px;
        box-shadow: 0 0 15px rgba(0,0,0,0.3);
      }

      .custom-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .custom-modal-close {
        font-size: 1.5rem;
        cursor: pointer;
        background: #F15A29;
        color: white;
        padding: 8px 12px;
        border-radius: 50%;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        font-weight: bold;
      }

      .custom-modal-close:hover {
        background: #d14a1f;
        transform: scale(1.1);
      }

      .custom-modal-body {
        margin-bottom: 1rem;
      }

      .custom-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1rem;
      }
</style>

<div class="row">
  <div class="col-12">
    <a href="{% url 'office_quote_list' %}" class="text-primary mb-4"><i class="fa fa-arrow-left" aria-hidden="true"></i>
        Back to Office Quotes</a>
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
          <i class="fa-solid fa-building me-2 text-primary"></i>Office Quote #{{ office_quote.id }}
        </h2>
        <span class="status-badge status-{{ office_quote.status }}">
            {{ office_quote.get_status_display }}
        </span>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <div class="quote-card">
      <div class="quote-header">
        <div class="row">
          <div class="col-md-6">
            <h4 class="text-primary mb-2">{{ office_quote.name }}</h4>
            <p class="mb-1"><strong>Email:</strong> {{ office_quote.email }}</p>
            <p class="mb-1"><strong>Phone:</strong> {{ office_quote.phone_number }}</p>
            <p class="mb-0"><strong>Square Footage:</strong> {{ office_quote.square_footage }}</p>
          </div>
          <div class="col-md-6 text-md-end">
            <p class="mb-1"><strong>Quote ID:</strong> #{{ office_quote.id }}</p>
            <p class="mb-1"><strong>Submitted:</strong> {{ office_quote.created_at|date:"F d, Y \a\t g:i A" }}</p>
            <p class="mb-0"><strong>Last Updated:</strong> {{ office_quote.created_at|date:"F d, Y \a\t g:i A" }}</p>
          </div>
        </div>
      </div>

      <div class="quote-body">
        <form method="post">
          {% csrf_token %}
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="status">Status</label>
                <select name="status" id="status" class="cmn-input">
                  <option value="pending" {% if office_quote.status == 'pending' %}selected{% endif %}>Pending</option>
                  <option value="reviewed" {% if office_quote.status == 'reviewed' %}selected{% endif %}>Reviewed</option>
                  <option value="quoted" {% if office_quote.status == 'quoted' %}selected{% endif %}>Quoted</option>
                  <option value="accepted" {% if office_quote.status == 'accepted' %}selected{% endif %}>Accepted</option>
                  <option value="declined" {% if office_quote.status == 'declined' %}selected{% endif %}>Declined</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="admin_notes">Admin Notes</label>
                <textarea name="admin_notes" id="admin_notes" class="cmn-input" rows="3" placeholder="Add internal notes about this quote...">{{ office_quote.admin_notes|default:'' }}</textarea>
              </div>
            </div>
          </div>

          <div class="form-group mb-3">
            <label for="business_address">Business Address</label>
            <textarea id="business_address" class="cmn-input" rows="3" readonly>{{ office_quote.business_address }}</textarea>
          </div>

          <div class="form-group mb-3">
            <label for="job_description">Job Description</label>
            <textarea id="job_description" class="cmn-input" rows="4" readonly>{{ office_quote.job_description }}</textarea>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fa-solid fa-save me-2"></i>Update Quote
            </button>
            <a href="{% url 'office_quote_list' %}" class="btn btn-secondary">
              <i class="fa-solid fa-arrow-left me-2"></i>Back to List
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-4">
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-primary">Quick Actions</h5>
              <div class="d-grid gap-2">
                <button class="btn btn-outline-success" onclick="openEmailModal()">
                  <i class="fa-solid fa-envelope me-2"></i>Send Email to Customer
                </button>
                <a href="{% url 'generate_office_quote_pdf' office_quote.id %}" class="btn btn-outline-info" target="_blank">
                  <i class="fa-solid fa-file-invoice me-2"></i>Generate Quote PDF
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-primary">Quote History</h5>
              <p class="card-text">
                <strong>Created:</strong> {{ office_quote.created_at|date:"M d, Y" }}<br>
                <strong>Status Changes:</strong> {{ office_quote.status|title }}<br>
                <strong>Last Activity:</strong> {{ office_quote.created_at|date:"M d, Y" }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Email Modal -->
<div id="emailModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header">
      <h5>Send Email to Customer</h5>
      <span class="custom-modal-close" onclick="closeEmailModal()">&times;</span>
    </div>
    <form method="post" action="{% url 'send_office_quote_email' office_quote.id %}">
      {% csrf_token %}
      <div class="custom-modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label for="email_type" class="form-label">Email Type</label>
              <select name="email_type" id="email_type" class="cmn-input" required>
                <option value="">Select email type...</option>
                <option value="general">General Information</option>
                <option value="quote_update">Quote Update</option>
                <option value="status_update">Status Update</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group mb-3">
              <label class="form-label">Customer Information</label>
              <div class="form-control-plaintext">
                <strong>{{ office_quote.name }}</strong><br>
                <small>{{ office_quote.email }}</small>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group mb-3">
          <label for="custom_message" class="form-label">Custom Message (Optional)</label>
          <textarea name="custom_message" id="custom_message" class="cmn-input" rows="4" 
                    placeholder="Add a personal message or additional information for the customer..."></textarea>
        </div>
        
        <div class="alert alert-info">
          <i class="fa-solid fa-info-circle me-2"></i>
          <strong>Email Preview:</strong> The email will be sent to <strong>{{ office_quote.email }}</strong> with the selected template and your custom message.
        </div>
      </div>
      <div class="custom-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeEmailModal()">
          <i class="fa-solid fa-times me-2"></i>Cancel
        </button>
        <button type="submit" class="btn btn-success">
          <i class="fa-solid fa-paper-plane me-2"></i>Send Email
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function openEmailModal() {
  // Reset form
  document.getElementById('email_type').value = '';
  document.getElementById('custom_message').value = '';
  
  // Show modal
  document.getElementById('emailModal').style.display = 'block';
}

function closeEmailModal() {
  document.getElementById('emailModal').style.display = 'none';
}

// Auto-close alerts after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    var alerts = document.querySelectorAll('.alert');
    alerts.forEach(function(alert) {
      var bsAlert = new bootstrap.Alert(alert);
      bsAlert.close();
    });
  }, 5000);
});

// Close modal when clicking outside it
window.onclick = function(event) {
  const modal = document.getElementById('emailModal');
  if (event.target === modal) {
    closeEmailModal();
  }
}
</script>

{% endblock %}
