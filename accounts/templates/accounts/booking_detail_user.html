{% extends "accounts/partials/account_base.html" %}
{% load static %}
{% block account_content %}
<style>
  .card {
    border: 1px solid #F15A29;
  }
</style>
<div class="col-12 col-lg-8">
  <div class="container py-4">
    <h2>üìã Booking Details</h2>
    <p>Thank you, {{ booking.name }}! Here's your full booking breakdown:</p>

    <!-- Service Type Header -->
    <div class="alert {% if 'commercial' in booking.service_cat.name|lower or 'office' in booking.service_cat.name|lower %}alert-info{% else %}alert-success{% endif %} mb-4">
      <h5 class="mb-2">
        <strong>Service Type:</strong> {{ booking.service_cat.name }}
        {% if 'commercial' in booking.service_cat.name|lower or 'office' in booking.service_cat.name|lower %}
          <i class="fa fa-building ms-2"></i> Commercial/Office Cleaning
        {% else %}
          <i class="fa fa-home ms-2"></i> Home Cleaning
        {% endif %}
      </h5>
    </div>

    <!-- Booking Progress Timeline -->
    <div class="card mt-4">
      <div class="card-body">
        <h4>üïì Booking Progress</h4>
        <div class="d-flex justify-content-between text-center align-items-center flex-wrap">
          {% with status=booking.status %}
            <div class="flex-fill px-2">
              <div class="badge {% if status == 'pending' or status == 'confirmed' or status == 'completed' %}bg-primary{% else %}bg-light text-muted{% endif %}">Pending</div>
              <small class="d-block mt-1">Request Received</small>
            </div>
            <div class="flex-fill px-2">
              <div class="badge {% if status == 'confirmed' or status == 'completed' %}bg-primary{% else %}bg-light text-muted{% endif %}">Confirmed</div>
              <small class="d-block mt-1">Scheduled</small>
            </div>
            <div class="flex-fill px-2">
              <div class="badge {% if status == 'completed' %}bg-primary{% else %}bg-light text-muted{% endif %}">Completed</div>
              <small class="d-block mt-1">Done</small>
            </div>
          {% endwith %}
        </div>
      </div>
    </div>

    <!-- Booking Summary -->
    <div class="card mt-4 shadow-sm position-relative">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <h5 class="mb-0">üì¶ Booking Summary</h5>
    
          {% if booking.pdf_file %}
            <a href="{{ booking.pdf_file.url }}" target="_blank" class="btn btn-md btn-outline-dark">
              üßæ Download PDF
            </a>
          {% endif %}
        </div>
    
        <div class="row align-items-center">
          <!-- Left: Info -->
          <div class="col-md-8">
            <p class="mb-2"><strong>Service:</strong> {{ booking.service_cat.name }}</p>
            <p class="mb-2"><strong>Date:</strong> {{ booking.date }} at {{ booking.hour }}</p>
            
            <!-- Service Type Specific Details -->
            {% if 'commercial' in booking.service_cat.name|lower or 'office' in booking.service_cat.name|lower %}
              <!-- Commercial/Office Details -->
              <p class="mb-2"><strong>Business Type:</strong> {{ booking.business_type|default:"Not specified" }}</p>
              <p class="mb-2"><strong>Cleaners:</strong> {{ booking.num_cleaners|default:"Not specified" }}, <strong>Hours:</strong> {{ booking.hours_requested|default:"Not specified" }}</p>
              <p class="mb-2"><strong>Cleaning Frequency:</strong> 
                {% if booking.cleaning_frequency != "one_time" %}
                  {{ booking.cleaning_frequency|title }}
                {% else %}
                  One-time
                {% endif %}
              </p>
            {% else %}
              <!-- Residential/Home Details -->
              {% if booking.is_large_home %}
                <p class="mb-2"><strong>Cleaners:</strong> {{ booking.num_cleaners }}, <strong>Hours:</strong> {{ booking.hours_requested }}</p>
              {% else %}
                <p class="mb-2"><strong>Hours:</strong> {{ booking.hours_requested }}</p>
              {% endif%}
            {% endif %}
            
            <p class="mb-2">
              <strong>Total Price:</strong>
              <span class="badge rounded-pill" style="background-color: #F15A29; color: #fff; font-size: 1rem;">
                ${{ booking.price|floatformat:2 }}
              </span>
            </p>
            <p class="mb-2">
              <strong>Status:</strong>
              <span class="badge 
                {% if booking.status == 'pending' %}bg-warning text-dark
                {% elif booking.status == 'confirmed' %}bg-success
                {% elif booking.status == 'cancelled' %}bg-danger
                {% else %}bg-secondary
                {% endif %}
              ">
                {{ booking.status|title }}
              </span>
            </p>
          </div>
    
          <!-- Right: Action Buttons -->
          <div class="col-md-4 text-md-end text-start mt-3 mt-md-0">
            {% if booking.status == "pending" or booking.status == "confirmed" %}
              <div class="d-flex flex-md-column gap-2 justify-content-md-end">
                <a href="{% url 'reschedule_booking' booking.id %}" class="btn btn-outline-primary w-100">
                  üìÖ Reschedule
                </a>
                <form method="post" action="{% url 'cancel_booking' booking.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-outline-danger w-100"
                    onclick="return confirm('Are you sure you want to cancel this booking?')">
                    ‚ùå Cancel
                  </button>
                </form>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    
    

    <!-- Compact 2-column layout for sections -->
<div class="row mt-4 g-4">

  <!-- Price Breakdown -->
  <div class="col-md-6">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">üí∞ Price Breakdown</h5>
        <ul class="list-group list-group-flush small">
          {% if 'commercial' in booking.service_cat.name|lower or 'office' in booking.service_cat.name|lower %}
            <!-- Commercial/Office Price Breakdown -->
            <li class="list-group-item">Service Type: {{ booking.service_cat.name }}</li>
            {% if booking.business_type %}
              <li class="list-group-item">Business Type: {{ booking.business_type }}</li>
            {% endif %}
            <li class="list-group-item">Number of Cleaners: {{ booking.num_cleaners|default:"Not specified" }}</li>
            <li class="list-group-item">Hours Requested: {{ booking.hours_requested|default:"Not specified" }}</li>
            <li class="list-group-item">Cleaning Frequency: 
              {% if booking.cleaning_frequency != "one_time" %}
                {{ booking.cleaning_frequency|title }}
              {% else %}
                One-time
              {% endif %}
            </li>
          {% else %}
            <!-- Residential/Home Price Breakdown -->
            {% if booking.square_feet_options %}
              <li class="list-group-item">Square Footage: {{ booking.square_feet_options.name }}</li>
            {% endif %}
            {% if not booking.is_large_home and booking.home_types %}
              <li class="list-group-item">Home Type: {{ booking.home_types.name }} (${{ booking.home_types.price }})</li>
            {% endif %}
            {% if booking.is_large_home %}
              <li class="list-group-item">Cleaners: {{ booking.num_cleaners }}</li>
              <li class="list-group-item">Labor Cost: {{ booking.calculate_subtotal|floatformat:2 }}</li>
            {% endif %}
          {% endif %}
          
          <!-- Common Extras -->
          {% for extra in booking.extras.all %}
            <li class="list-group-item ps-4">+ {{ extra.name }} ‚Äî ${{ extra.price }}</li>
          {% endfor %}
          
          <li class="list-group-item">Subtotal: ${{ booking.calculate_subtotal }}</li>
          <li class="list-group-item">Tax: ${{ booking.calculate_tax }}</li>
          {% if booking.gift_card_discount > 0 %}
            <li class="list-group-item">Gift Card or Discount: ${{ booking.gift_card_discount }}</li>
          {% endif %}
        </ul>
        <h6 class="mt-3 text-primary fw-bold">Total: ${{ booking.price }}</h6>
      </div>
    </div>
  </div>

  <!-- Schedule Info -->
  <div class="col-md-6">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">üìÖ Schedule</h5>
        <p class="mb-2"><strong>Date:</strong> {{ booking.date }}</p>
        <p class="mb-2"><strong>Time:</strong> {{ booking.hour|time:"H:i" }}</p>
        <p class="mb-2"><strong>Duration:</strong> {{ booking.hours_requested }} hour(s)</p>
        {% if 'commercial' in booking.service_cat.name|lower or 'office' in booking.service_cat.name|lower %}
          <p class="mb-0"><strong>Frequency:</strong> 
            {% if booking.cleaning_frequency != "one_time" %}
              {{ booking.cleaning_frequency|title }}
            {% else %}
              One-time
            {% endif %}
          </p>
        {% else %}
          <p class="mb-0"><strong>Recurring:</strong> 
            {% if booking.recurrence_pattern != "one_time" %}
              {{ booking.get_recurrence_pattern_display }}
            {% else %}
              One-time
            {% endif %}
          </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Service Specific Info -->
  {% if 'commercial' in booking.service_cat.name|lower or 'office' in booking.service_cat.name|lower %}
    <!-- Commercial/Office Info -->
    <div class="col-md-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">üè¢ Business Info</h5>
          <p class="mb-2"><strong>Business Type:</strong> {{ booking.business_type|default:"Not specified" }}</p>
          <p class="mb-2"><strong>Service Category:</strong> {{ booking.service_cat.name }}</p>
          <p class="mb-2"><strong>Number of Cleaners:</strong> {{ booking.num_cleaners|default:"Not specified" }}</p>
          <p class="mb-0"><strong>Hours Requested:</strong> {{ booking.hours_requested|default:"Not specified" }}</p>
        </div>
      </div>
    </div>
  {% else %}
    <!-- Home Info -->
    <div class="col-md-6">
      <div class="card h-100 shadow-sm">
        <div class="card-body">
          <h5 class="mb-3">üè† Home Info</h5>
          {% if booking.home_types %}
            <p class="mb-2"><strong>Home Type:</strong> {{ booking.home_types.name }}</p>
          {% endif %}
          {% if booking.square_feet_options %}
            <p class="mb-2"><strong>Square Feet:</strong> {{ booking.square_feet_options.name }}</p>
          {% endif %}
          <p class="mb-2"><strong>Is Large Home:</strong> {{ booking.is_large_home|yesno:"Yes,No" }}</p>
          <p class="mb-0"><strong>Address:</strong> {{ booking.address }}{% if booking.apartment %}, Apt {{ booking.apartment }}{% endif %}</p>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- Location Info (Common to both) -->
  <div class="col-md-6">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">üìç Location</h5>
        <p class="mb-2"><strong>Address:</strong> {{ booking.address }}{% if booking.apartment %}, Apt {{ booking.apartment }}{% endif %}</p>
        <p class="mb-0"><strong>ZIP:</strong> {{ booking.zip_code }}</p>
      </div>
    </div>
  </div>

  <!-- Customer Info -->
  <div class="col-md-6">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">üë§ Customer Info</h5>
        <p class="mb-2"><strong>Name:</strong> {{ booking.name }}</p>
        <p class="mb-2"><strong>Email:</strong> {{ booking.email }}</p>
        <p class="mb-0"><strong>Phone:</strong> {{ booking.phone }}</p>
        
        <!-- Additional Commercial Info -->
        {% if 'commercial' in booking.service_cat.name|lower or 'office' in booking.service_cat.name|lower %}
          {% if booking.company_name %}
            <p class="mb-2"><strong>Company:</strong> {{ booking.company_name }}</p>
          {% endif %}
          {% if booking.contact_person and booking.contact_person != booking.name %}
            <p class="mb-0"><strong>Contact Person:</strong> {{ booking.contact_person }}</p>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Review Form -->
<div class="col-md-12">
  <div class="card h-100 shadow-sm mt-3">
    <div class="card-body">
      <h5 class="mb-3">üìù Leave a Review</h5>
      {% if review_submitted %}
        <div class="alert alert-success">Thank you for your review!</div>
      {% endif %}
      <form method="post" action="">
        {% csrf_token %}
        {{ review_form.non_field_errors }}
        <div class="mb-3">
          <label for="id_rating" class="form-label"><strong>Rating (1-5)</strong></label>
          {{ review_form.rating }}
          {% for error in review_form.rating.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
        </div>
        <div class="mb-3">
          <label for="id_review" class="form-label"><strong>Your Review</strong></label>
          {{ review_form.review }}
          {% for error in review_form.review.errors %}<div class="text-danger">{{ error }}</div>{% endfor %}
        </div>
        <div class="d-grid">
          <button type="submit" class="btn btn-primary">Submit Review</button>
        </div>
      </form>
      {% if reviews %}
        <hr />
        <h6 class="mt-4">Previous Reviews</h6>
        <ul class="list-group mt-2">
          {% for r in reviews %}
            <li class="list-group-item">
              <strong>Rating:</strong> {{ r.rating }}<br />
              <strong>Review:</strong> {{ r.review|linebreaksbr }}<br />
              <small class="text-muted">{{ r.created_at|date:"M d, Y H:i" }}</small>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  </div>
</div>


</div>


    <div class="mt-4 text-center">
      <a href="{% url 'my_bookings' %}" class="btn-1">‚Üê Back to My Bookings</a>
    </div>
  </div>
</div>

<div class="col-12 col-lg-4 mt-4 mt-lg-0">
  <!-- Booking options as big buttons -->
  <div class="row mb-5">
    <div class="col-md-12">
      <div class="card h-100 shadow-sm border-0 text-center p-4">
        <div class="card-body">
          <h4 class="mb-3">üßº Book Home Cleaning</h4>
          <p class="mb-4">Schedule a professional cleaning with flexible extras and recurring options.</p>
                      <a href="{% url 'request_cleaning_booking' %}" class="btn-1 w-100">Book Home Cleaning</a>
        </div>
      </div>
    </div>
    <div class="col-md-12 mt-4">
      <div class="card h-100 shadow-sm border-0 text-center p-4">
        <div class="card-body">
          <h4 class="mb-3">üè¢ Book Office Cleaning</h4>
          <p class="mb-4">Professional cleaning services for offices, retail spaces, and commercial properties.</p>
                      <a href="{% url 'office_cleaning_booking' %}" class="btn-1 w-100">Book Office Cleaning</a>
        </div>
      </div>
    </div>
    <!-- <div class="col-md-12 mt-4">
      <div class="card h-100 shadow-sm border-0 text-center p-4">
        <div class="card-body">
          <h4 class="mb-3">üõ†Ô∏è Book Handyman</h4>
          <p class="mb-4">Need help with home repairs, installations, or improvements?</p>
          <a href="{% url 'request_handyman_booking' %}" class="btn-1 w-100">Book Handyman</a>
        </div>
      </div>
    </div> -->
  </div>
</div>
{% endblock %}
