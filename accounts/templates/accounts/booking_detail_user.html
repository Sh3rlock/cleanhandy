{% extends "accounts/partials/account_base.html" %}
{% load static %}
{% block account_content %}
<div class="col-8">
  <div class="container py-4">
    <h2>üìã Booking Details</h2>
    <p>Thank you, {{ booking.name }}! Here's your full booking breakdown:</p>

    <!-- Booking Progress Timeline -->
    <div class="card mt-4">
      <div class="card-body">
        <h4>üïì Booking Progress</h4>
        <div class="d-flex justify-content-between text-center align-items-center flex-wrap">
          {% with status=booking.status %}
            <div class="flex-fill px-2">
              <div class="badge {% if status == 'pending' or status == 'confirmed' or status == 'completed' %}bg-primary{% else %}bg-light text-muted{% endif %}">Pending</div>
              <small class="d-block mt-1">Request Received</small>
            </div>
            <div class="flex-fill px-2">
              <div class="badge {% if status == 'confirmed' or status == 'completed' %}bg-primary{% else %}bg-light text-muted{% endif %}">Confirmed</div>
              <small class="d-block mt-1">Scheduled</small>
            </div>
            <div class="flex-fill px-2">
              <div class="badge {% if status == 'completed' %}bg-primary{% else %}bg-light text-muted{% endif %}">Completed</div>
              <small class="d-block mt-1">Done</small>
            </div>
          {% endwith %}
        </div>
      </div>
    </div>

    <!-- Booking Summary -->
    <div class="card mt-4">
      <div class="card-body">
        <h4>üì¶ Summary</h4>
        <p><strong>Service:</strong> {{ booking.service_cat.name }}</p>
        <p><strong>Date:</strong> {{ booking.date }} at {{ booking.hour }}</p>
        <p>
          <strong>Status:</strong>
          <span class="badge 
            {% if booking.status == 'pending' %}bg-warning text-dark
            {% elif booking.status == 'confirmed' %}bg-success
            {% elif booking.status == 'cancelled' %}bg-danger
            {% else %}bg-secondary
            {% endif %}
          ">
            {{ booking.status|title }}
          </span>
        </p>
        {% if booking.pdf_file %}
          <p><a href="{{ booking.pdf_file.url }}" target="_blank" class="btn btn-md btn-outline-dark">üßæ Download PDF</a></p>
        {% endif %}

        {% if booking.status == "pending" or booking.status == "confirmed" %}
          <div class="d-flex gap-2 mt-3">
            <a href="{% url 'reschedule_booking' booking.id %}" class="btn btn-outline-primary">üìÖ Reschedule</a>
            <form method="post" action="{% url 'cancel_booking' booking.id %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to cancel this booking?')">‚ùå Cancel</button>
            </form>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Price Breakdown -->
    <div class="card mt-4">
      <div class="card-body">
        <h4>üí∞ Price Breakdown</h4>
        <ul class="list-group list-group-flush">
          {% if booking.square_feet_options %}
            <li class="list-group-item">Square Footage ({{ booking.square_feet_options.name }})</li>
          {% endif %}

          {% if not booking.is_large_home and booking.home_types %}
            <li class="list-group-item">Home Type ({{ booking.home_types.name }}): ${{ booking.home_types.price }}</li>
          {% endif %}

          {% if booking.extras.all %}
            {% with booking.extras.all as extras %}
              {% if extras %}
                <li class="list-group-item">Extras:</li>
                {% for extra in extras %}
                  <li class="list-group-item ps-4">+ {{ extra.name }} ‚Äî ${{ extra.price }}</li>
                {% endfor %}
              {% endif %}
            {% endwith %}
          {% endif %}

          {% if booking.is_large_home %}
            <li class="list-group-item">Cleaning Type: {{ booking.cleaning_type|title }}</li>
            <li class="list-group-item">Number of Cleaners: {{ booking.num_cleaners }}</li>
            <li class="list-group-item">
              Labor Cost:
              ${{ booking.num_cleaners|floatformat:0 }} √ó {{ booking.hours_requested|floatformat:0 }} hr √ó 
              {% if booking.cleaning_type and booking.cleaning_type|lower == "post-renovation" %}
                $60
              {% else %}
                $55
              {% endif %}
              = ${{ booking.calculate_subtotal|floatformat:2 }}
            </li>
          {% endif %}

          <li class="list-group-item">Subtotal: ${{ booking.calculate_subtotal }}</li>
          <li class="list-group-item">Sales Tax (8.875%): ${{ booking.calculate_tax }}</li>
        </ul>
        <h5 class="mt-3 text-primary">üíµ Total Price: <strong>${{ booking.price }}</strong></h5>
      </div>
    </div>

    <!-- Schedule Info -->
    <div class="card mt-4">
      <div class="card-body">
        <h4>üìÖ Scheduled Info</h4>
        <p><strong>Date:</strong> {{ booking.date }}</p>
        <p><strong>Time:</strong> {{ booking.hour|time:"H:i" }}</p>
        <p><strong>Duration:</strong> {{ booking.hours_requested }} hour(s)</p>
        <p><strong>Recurring:</strong> 
          {% if booking.recurrence_pattern != "one_time" %}
            {{ booking.get_recurrence_pattern_display }}
          {% else %}
            One-time
          {% endif %}
        </p>
      </div>
    </div>

    <!-- Home Info -->
    <div class="card mt-4">
      <div class="card-body">
        <h4>üè† Home Info</h4>
        {% if booking.home_types %}
          <p><strong>Home Type:</strong> {{ booking.home_types.name }}</p>
        {% endif %}
        {% if booking.square_feet_options %}
          <p><strong>Square Feet:</strong> {{ booking.square_feet_options.name }}</p>
        {% endif %}
        <p><strong>Address:</strong> {{ booking.address }}{% if booking.apartment %}, Apt {{ booking.apartment }}{% endif %}</p>
        <p><strong>ZIP:</strong> {{ booking.zip_code }}</p>
      </div>
    </div>

    <!-- Customer Info -->
    <div class="card mt-4">
      <div class="card-body">
        <h4>üë§ Customer Info</h4>
        <p><strong>Name:</strong> {{ booking.name }}</p>
        <p><strong>Email:</strong> {{ booking.email }}</p>
        <p><strong>Phone:</strong> {{ booking.phone }}</p>
      </div>
    </div>

    <div class="mt-4 text-center">
      <a href="{% url 'my_bookings' %}" class="btn-1">‚Üê Back to My Bookings</a>
    </div>
  </div>
</div>

<div class="col-lg-4">
  <!-- Booking options as big buttons -->
  <div class="row mb-5">
    <div class="col-md-12">
      <div class="card h-100 shadow-sm border-0 text-center p-4">
        <div class="card-body">
          <h4 class="mb-3">üßº Book Cleaning</h4>
          <p class="mb-4">Schedule a professional cleaning with flexible extras and recurring options.</p>
          <a href="{% url 'request_cleaning_booking' service_cat.id %}" class="btn-1 w-100">Book Cleaning</a>
        </div>
      </div>
    </div>
    <div class="col-md-12 mt-4">
      <div class="card h-100 shadow-sm border-0 text-center p-4">
        <div class="card-body">
          <h4 class="mb-3">üõ†Ô∏è Book Handyman</h4>
          <p class="mb-4">Need help with home repairs, installations, or improvements?</p>
          <a href="" class="btn-1 w-100">Book Handyman</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
